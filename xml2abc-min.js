var vertaal,xml2abc_VERSION=118,gGotMicrotonalAccidental=!1;!function(){"use strict";function t(t,e){return Array(t+1).join(e)}function e(t,e){for(var i=[];t;)i.push(e),--t;return i}function i(t,e){for(var i=0,n={};i<t.length;++i)n[t[i]]=e[i];return n}function n(t,e){var i=t.split(/%[ds]/);return i.length>e.length&&e.push(""),e.map(function(t,e){return i[e]+t}).join("")}function s(t,e){h.info(n(t,e))}function r(t,e){return -1!==t.indexOf(e,t.length-e.length)}function a(t){return Object.keys(t).map(function(t){return parseInt(t)})}function o(t,e){var i,n,s=[];if(Array.isArray(t))for(n=0;n<t.length;++n)n in t&&s.push([n,t[n]]);else for(n in t)s.push([n,t[n]]);return i=e?function(t,e){return t[0]-e[0]}:function(t,e){return t[1]-e[1]||e[0]-t[0]},s.sort(i),s}var h,f={"ornaments>trill-mark":"T","ornaments>mordent":"M","ornaments>inverted-mordent":"P","ornaments>turn":"!turn!","ornaments>inverted-turn":"!invertedturn!","technical>up-bow":"u","technical>down-bow":"v","technical>harmonic":"!open!","technical>open-string":"!open!","technical>stopped":"!plus!","technical>snap-pizzicato":"!snap!","technical>thumb-position":"!thumb!","articulations>accent":"!>!","articulations>strong-accent":"!^!","articulations>staccato":".","articulations>staccatissimo":"!wedge!","articulations>scoop":"!slide!",fermata:"!fermata!",arpeggiate:"!arpeggio!","articulations>tenuto":"!tenuto!","articulations>spiccato":"!wedge!","articulations>breath-mark":"!breath!","articulations>detached-legato":"!tenuto!."},p={p:"!p!",pp:"!pp!",ppp:"!ppp!",pppp:"!pppp!",f:"!f!",ff:"!ff!",fff:"!fff!",ffff:"!ffff!",mp:"!mp!",mf:"!mf!",sfz:"!sfz!"},c=["%%beginsvg\n<defs>",'<text id="x" x="-3" y="0">&#xe263;</text>','<text id="x-" x="-3" y="0">&#xe263;</text>','<text id="x+" x="-3" y="0">&#xe263;</text>','<text id="normal" x="-3.7" y="0">&#xe0a3;</text>','<text id="normal-" x="-3.7" y="0">&#xe0a3;</text>','<text id="normal+" x="-3.7" y="0">&#xe0a4;</text>','<g id="circle-x"><text x="-3" y="0">&#xe263;</text><circle r="4" class="stroke"></circle></g>','<g id="circle-x-"><text x="-3" y="0">&#xe263;</text><circle r="4" class="stroke"></circle></g>','<path id="triangle" d="m-4 -3.2l4 6.4 4 -6.4z" class="stroke" style="stroke-width:1.4"></path>','<path id="triangle-" d="m-4 -3.2l4 6.4 4 -6.4z" class="stroke" style="stroke-width:1.4"></path>','<path id="triangle+" d="m-4 -3.2l4 6.4 4 -6.4z" class="stroke" style="fill:#000"></path>','<path id="square" d="m-3.5 3l0 -6.2 7.2 0 0 6.2z" class="stroke" style="stroke-width:1.4"></path>','<path id="square-" d="m-3.5 3l0 -6.2 7.2 0 0 6.2z" class="stroke" style="stroke-width:1.4"></path>','<path id="square+" d="m-3.5 3l0 -6.2 7.2 0 0 6.2z" class="stroke" style="fill:#000"></path>','<path id="diamond" d="m0 -3l4.2 3.2 -4.2 3.2 -4.2 -3.2z" class="stroke" style="stroke-width:1.4"></path>','<path id="diamond-" d="m0 -3l4.2 3.2 -4.2 3.2 -4.2 -3.2z" class="stroke" style="stroke-width:1.4"></path>','<path id="diamond+" d="m0 -3l4.2 3.2 -4.2 3.2 -4.2 -3.2z" class="stroke" style="fill:#000"></path>',"</defs>\n%%endsvg"],d=["%%beginsvg\n",'<style type="text/css">\n',".bf {font-family:sans-serif; font-size:7px}\n","</style>\n","<defs>\n",'<rect id="clr" x="-3" y="-1" width="6" height="5" fill="white"></rect>\n','<rect id="clr2" x="-3" y="-1" width="11" height="5" fill="white"></rect>\n'],l='<g id="kop%s" class="bf"><use xlink:href="#clr"></use><text x="-2" y="3">%s</text></g>\n',u='<g id="kop%s" class="bf"><use xlink:href="#clr2"></use><text x="-2" y="3">%s</text></g>\n';function m(t){this.reset(),this.ixp=t,this.ixm=0,this.mdur=0,this.divs=0,this.mtr=[4,4]}function g(t,e){this.tijd=0,this.dur=t,this.fact=null,this.tup=[""],this.tupabc="",this.beam=0,this.grace=0,this.before=[],this.after="",this.ns=e?[e]:[],this.lyrs={},this.pos=0,this.tab=null,this.ntdec=""}function _(t){this.tijd=0,this.str=t,this.pos=0}function v(){}function x(t){this.tijd=0,this.maxtime=0,this.gMaten=[],this.gLyrics=[],this.vnums={},this.cnt=new v,this.vceCnt=1,this.lastnote=null,this.bpl=t.b,this.cpl=t.n,this.repbra=0,this.nvlt=t.v,this.addstavenum=t.addstavenum}function b(t,e,i,n){this.fnmext=t,this.outlist=[],this.infolist=[],this.title="T:Title",this.key="none",this.clefs={},this.mtr="none",this.tempo=0,this.tempo_units=[1,4],this.pad=e,this.X=i+1,this.denL=n.d,this.volpan=n.m,this.cmpL=[],this.scale="",this.tstep=n.t,this.stemless=0,this.pagewidth="",this.leftmargin="",this.rightmargin="",this.shiftStem=n.s,this.mnum=n.mnum,4==n.p.length&&(this.scale=""!=n.p[0]?parseFloat(n.p[0]):"",this.pagewidth=""!=n.p[1]?parseFloat(n.p[1]):"",this.leftmargin=""!=n.p[2]?parseFloat(n.p[2]):"",this.rightmargin=""!=n.p[3]?parseFloat(n.p[3]):"")}function y(t,e){if(!t.join(""))return["",0];for(var i=[],n=0;n<t.length;++n){var s=t[n];""==s?s=e?"_":"*":r(s,"_")&&!r(s,"\\_")?(s=s.replace("_",""),e=1):e=0,i.push(s)}return[i.join(" "),e]}function k(t,e){for(var i,n=t,s=e;e;)i=t%e,t=e,e=i;return[n/t,s/t]}function w(t,e,i){if(0==t.dur)return"";if(n=(f=k(i*t.dur,4*e))[0],r=f[1],t.fact&&(n=(f=k(n*(a=t.fact[0]),r*(o=t.fact[1])))[0],r=f[1]),r>64){var n,r,a,o,h,f,p=n/r,c=Math.floor(p);p-c<.1*p&&(n=c,r=1),f=k(Math.round(64*n/r)||1,64),s("denominator too small: %d/%d rounded to %d/%d",[n,r,f[0],f[1]]),n=f[0],r=f[1]}return 1==n?1==r?"":2==r?"/":"/"+r:1==r?""+n:n+"/"+r}function j(t){var e=t.match(/([_^]*)([A-Ga-g])([',]*)/);if(!e)return -1;var i,n,s=e[1],r=e[2],a=e[3];return i=r.toUpperCase(),n=60+[0,2,4,5,7,9,11]["CDEFGAB".indexOf(i)]+(i!=r?12:0),s&&(n+=("^"==s[0]?1:-1)*s.length),a&&(n+=("'"==a[0]?12:-12)*a.length),n}function M(t,e,i){var s,r,a,o,h,f,p,c,d,l=0,u=e[t],m=u.tup.indexOf("start");m>-1&&u.tup.splice(m,1);var g=t;for(a=i[0],o=i[1],r=[(h=u.fact[0])/a,(f=u.fact[1])/o];t<e.length;){if((u=e[t])instanceof _||u.grace){t+=1;continue}if(u.tup.indexOf("start")>-1?(t=(d=M(t,e,r))[0],l+=p=d[1]):u.fact&&(l+=1),(m=u.tup.indexOf("stop"))>-1){u.tup.splice(m,1);break}if(!u.fact){t=s;break}s=t,t+=1}var v=[r[0],r[1],l];return c="3,2,3"==v.toString()?"(3":n("(%d:%d:%d",v),e[g].tupabc=c+e[g].tupabc,[t,l]}function O(t){t=t.filter(function(t){return t instanceof g});for(var e=0;e<t.length-1;){var i=t[e],n=t[e+1];!i.fact&&!n.fact&&i.dur>0&&n.beam&&(3*i.dur==n.dur?(n.dur=2*n.dur/3,i.dur=2*i.dur,i.after="<"+i.after,e+=1):3*n.dur==i.dur&&(i.dur=2*i.dur/3,n.dur=2*n.dur,i.after=">"+i.after,e+=1)),e+=1}}function S(t,e,i,n,s){for(var a,o=0;o<t.length;){var h=t[o];h instanceof g&&h.fact&&!h.grace&&(o=(a=M(o,t,[1,1]))[0]),o+=1}for(var f,p,c=[],d=0;d<t.length;++d){if((h=t[d])instanceof g){var l=w(h,e,s),u=h.ns.length>1,m=h.ns.filter(function(t){return r(t,"-")});m=m.map(function(t){return t.slice(0,-1)});var _="";u&&m.length==h.ns.length&&(h.ns=m,_="-"),p=h.tupabc+h.before.join(""),u&&(p+="["),p+=h.ns.join(""),u&&(p+="]"+_),r(p,"-")&&(p=p.slice(0,-1),_="-"),p+=l+_,p+=h.after,f=h.beam}else h.str instanceof Array&&(h.str=h.str[0]),p=h.str,f=1;f?c.push(p):c.push(" "+p)}for(c=c.join("");c.indexOf("!ped!!ped!")>=0;)c=c.replace(/!ped!!ped!/g,"!ped!");for(;c.indexOf("!ped-up!!ped-up!")>=0;)c=c.replace(/!ped-up!!ped-up!/g,"!ped-up!");for(;c.indexOf("!8va(!!8va)!")>=0;)c=c.replace(/!8va\(!!8va\)!/g,"");return c}function C(t,e){t.map(function(t,e){t.pos=e}),t.sort(function(t,e){return t.tijd-e.tijd||t.pos-e.pos});for(var i=0,n=[],r=[],a=0;a<t.length;++a){var o=t[a];if(o.tijd>i&&F(o.tijd-i,e)&&(n.push(new g(o.tijd-i,"x")),r.push(n.length-1)),o instanceof _){o.tijd<i&&(o.tijd=i),n.push(o),i=o.tijd;continue}if(o.tijd<i){if("z"==o.ns[0])continue;var h=n[n.length-1];if(h.tijd<=o.tijd){if("z"==h.ns[0])h.dur=o.tijd-h.tijd,0==h.dur&&n.pop(),s("overlap in part %d, measure %d: rest shortened",[e.ixp+1,e.ixm+1]);else{if(h.ns=h.ns.concat(o.ns),s("overlap in part %d, measure %d: added chord",[e.ixp+1,e.ixm+1]),o.dur=o.tijd+o.dur-i,o.dur<=0)continue;o.tijd=i}}else{s("overlapping notes in one voice! part %d, measure %d, note %s discarded",[e.ixp+1,e.ixm+1,o instanceof g?o.ns:o.str]);continue}}if(n.push(o),o instanceof g){var f=o.ns[0];if("x"==f||"z"==f)r.push(n.length-1);else if(r.length){if(o.beam&&!o.grace)for(var p=0;p<r.length;++p)n[r[p]].beam=o.beam;r=[]}}i=o.tijd+o.dur}return 0==i&&s("empty measure in part %d, measure %d, it should contain at least a rest to advance the time!",[e.ixp+1,e.ixm+1]),n}function I(t){var e,i,n,s;if(0==t.length)return[];for(n=0,e=[];n<t.length;++n){if(1==(i=t[n]).length)e.push(""+i[0]);else{for(e.push("("),s=0;s<i.length;++s)e.push(""+i[s]);e.push(")")}e.push("|")}return e.splice(-1,1),t.length>1&&(e=["{"].concat(e).concat(["}"])),e}function E(t,e,i,n,s,r){var a,o;"name_tuple"==t[0]?(a=n.shift(),e[0]&&(t[1]=e[0]+":"+t[1],t[2]=e[1]+":"+t[2]),s.push(t),r.push.apply(r,I(a))):2==t.length&&"name_tuple"==t[0][0]?(a=n.shift(),(o=["name_tuple","",""])[1]=t[0][1]+":"+t[1][2],o[2]=t[0][2]+":"+t[1][3],s.push(o),r.push.apply(r,I(a))):function t(e,i,n,s,r){var a,o,h,f,p,c;for(a=(c=e[e.length-1])[0],o=c[1],h=c[2],f=c[3],o="yes"==o||i,r.push("brace"==a?"{":"["),p=0;p<e.length-1;++p)E(e[p],[h,f],o,n,s,r),o&&r.push("|");o&&r.splice(-1,1),r.push("brace"==a?"}":"]")}(t,i,n,s,r)}function L(t,e,i){for(var n,s,r=0,a=9007199254740992,o=[4,8,16];o.length;){var h=o.shift(),f=0;for(n=0;n<e.length;++n){var p=e[n][t];for(s=0;s<p.length;++s){var c=p[s];c instanceof _||0==c.dur||(f+=w(c,i[n],h).length)}}f<a&&(r=h,a=f)}return r}function D(t){for(var e="",i=t.children(),n=0;n<i.length;++n){var s=i[n];switch(s.tagName){case"elision":e+="~";break;case"text":e+=$(s).text().replace(/_/g,"\\_").replace(/-/g,"\\-").replace(/ /g,"~")}}if(!e)return e;var r=t.find("syllabic").text();return("begin"==r||"middle"==r)&&(e+="-"),t.find("extend").length&&(e+="_"),e}function A(t,e,i,n){if(0!=i){var s,r,a,o=e[i][n],h=t[i][n],f=t[i-1][n];for(s in f)r=f[s][1],!(s in h)&&r&&(a=B(o))&&(h[s]=[a,0])}}function B(t){for(var e=[],i=0;i<t.length;++i){var n=t[i];if(n instanceof g&&!n.grace){if("z"==n.ns[0]||"x"==n.ns[0])break;e.push("_")}}return e.join(" ")}function V(e,i){var n=e;return i>4&&(n=e.toLowerCase()),i>5&&(n+=t(i-5,"'")),i<4&&(n+=t(4-i,",")),n}function F(t,e){return t>e.divs/16?1:(s("MuseScore bug: incorrect duration, smaller then 1/64! in measure %d, part %d",[e.ixm,e.ixp]),0)}function N(t){this.slurBuf={},this.dirStk={},this.ingrace=0,this.msc=new x(t),this.unfold=t.u,this.ctf=t.c,this.gStfMap=[],this.midiMap=[],this.drumInst={},this.drumNotes={},this.instMid=[],this.midDflt=[-1,-1,-1,-91],this.msralts={},this.curalts={},this.stfMap={},this.vce2stf={},this.clefMap={},this.curClef={},this.stemDir={},this.clefOct={},this.curStf={},this.nolbrk=t.x,this.doPageFmt=1==t.p.length,this.tstep=t.t,this.dirtov1=t.v1,this.ped=!t.noped,this.wstems=t.stm,this.pedVce=null,this.repeat_str={},this.tabVceMap={},this.koppen={},this.note_alts=["=C,^C,=D,^D,=E,=F,^F,=G,^G,=A,^A,=B".split(","),"^B,_D,^^C,_E,_F,^E,_G,^^F,_A,^^G,_B,_C".split(","),"__D,^^B,__E,__F,^^D,__G,^^E,__A,_/A,__B,__C,^^A".split(",")],this.step_map={C:0,D:2,E:4,F:5,G:7,A:9,B:11}}m.prototype.reset=function(){this.attr="",this.lline="",this.rline="|",this.lnum=""},v.prototype.inc=function(t,e){this.counters[t][e]=(this.counters[t][e]||0)+1},v.prototype.clear=function(t){var n=Object.keys(t),s=e(n.length,0);this.counters={note:i(n,s),nopr:i(n,s),nopt:i(n,s)}},v.prototype.getv=function(t,e){return this.counters[t][e]},v.prototype.prcnt=function(t){for(var e in this.counters.note)0!=this.getv("nopr",e)&&s("part %d, voice %d has %d skipped non printable notes",[t,e,this.getv("nopr",e)]),0!=this.getv("nopt",e)&&s("part %d, voice %d has %d notes without pitch",[t,e,this.getv("nopt",e)]),0==this.getv("note",e)&&s("part %d, skipped empty voice %d",[t,e])},x.prototype.initVoices=function(t){for(var e in this.vtimes={},this.voices={},this.lyrics={},this.vnums)this.vtimes[e]=0,this.voices[e]=[],this.lyrics[e]=[];t&&this.cnt.clear(this.vnums)},x.prototype.incTime=function(t){this.tijd+=t,this.tijd<0&&(this.tijd=0),this.tijd>this.maxtime&&(this.maxtime=this.tijd)},x.prototype.appendElemCv=function(t,e){for(var i in t)this.appendElem(i,e)},x.prototype.insertElem=function(t,e){var i=new _(e);i.tijd=0,this.voices[t].unshift(i)},x.prototype.appendObj=function(t,e,i){e.tijd=this.tijd,this.voices[t].push(e),this.incTime(i),this.tijd>this.vtimes[t]&&(this.vtimes[t]=this.tijd)},x.prototype.appendElemT=function(t,e,i){var n=new _(e);n.tijd=i,this.voices[t].push(n)},x.prototype.appendElem=function(t,e,i){this.appendObj(t,new _(e),0),i&&this.cnt.inc("note",t)},x.prototype.appendNote=function(t,e,i){e.ns.push(e.ntdec+i),this.appendObj(t,e,parseInt(e.dur)),this.lastnote=e,"z"==i||"x"==i||(this.cnt.inc("note",t),e.grace||this.lyrics[t].push(e.lyrs))},x.prototype.getLastRec=function(t){if(this.gMaten.length){var e=this.gMaten[this.gMaten.length-1][t];return e[e.length-1]}return null},x.prototype.getLastMelis=function(t,e){if(this.gLyrics.length){var i=this.gLyrics[this.gLyrics.length-1][t];if(e in i)return i[e][1]}return 0},x.prototype.addChord=function(t,e){for(var i=0;i<t.before.length;i++){var n=t.before[i];0>this.lastnote.before.indexOf(n)&&this.lastnote.before.push(n)}this.lastnote.ns.push(t.ntdec+e)},x.prototype.addBar=function(t,e){for(var i in e.mdur&&this.maxtime>e.mdur&&s("measure %d in part %d longer than metre",[e.ixm+1,e.ixp+1]),this.tijd=this.maxtime,this.vnums){if(e.lline||e.lnum){var n=this.getLastRec(i);if(n){var r=n.str;e.lline&&(r=(r+e.lline).replace(/:\|:/g,"::").replace(/\|\|/g,"|")),3==this.nvlt?e.ixp+parseInt(i)==Math.min.apply(null,a(this.vnums))&&(r+=e.lnum):4==this.nvlt?parseInt(i)==Math.min.apply(null,a(this.vnums))&&(r+=e.lnum):e.lnum&&(r+=e.lnum,this.repbra=1),n.str=r}else e.lline&&this.insertElem(i,"|:")}t&&(n=this.getLastRec(i))&&(n.str+=t),e.attr&&this.insertElem(i,""+e.attr),this.appendElem(i," "+e.rline),this.voices[i]=C(this.voices[i],e);for(var o=this.lyrics[i],h={},f=o.reduce(function(t,e){return t.concat(a(e))},[]),p=Math.max.apply(null,f.concat([0])),c=p;c>0;--c){var d=o.map(function(t){return t[c]||""}),l=this.getLastMelis(i,c);h[c]=y(d,l)}this.lyrics[i]=h,O(this.voices[i])}this.gMaten.push(this.voices),this.gLyrics.push(this.lyrics),this.tijd=this.maxtime=0,this.initVoices()},x.prototype.outVoices=function(t,i){var n,s,r,f,p,c,d,l,u,m,g,_,v,x;for(l in p={},d=Math.min.apply(null,a(this.vnums)||[1]),this.vnums)if(0!=this.cnt.getv("note",l)){c=h.denL?h.denL:L(l,this.gMaten,t),h.cmpL.push(c);var b=[],y={};for(u=0;u<this.gMaten.length;++u)for(r in m=this.gMaten[u][l],b.push(S(m,t[u],u,i,c)),A(this.gLyrics,this.gMaten,u,l),g=this.gLyrics[u][l])if(_=(x=g[r])[0],r in y){for(;y[r].length<u;)y[r].push("");y[r].push(_)}else y[r]=e(u,"").concat([_]);for(r in y)f=y[r],v=b.length-f.length,y[r]=f.concat(e(v,""));h.add("V:"+this.vceCnt),this.repbra&&(1==this.nvlt&&this.vceCnt>1&&h.add("I:repbra 0"),2==this.nvlt&&parseInt(l)>d&&h.add("I:repbra 0")),this.cpl>0?this.bpl=0:0==this.bpl&&(this.cpl=100);for(var k=0;b.length;){for(var w=1,j=b[0];w<b.length&&(!(this.cpl>0)||!(j.length+b[w].length>=this.cpl))&&(!(this.bpl>0)||!(w>=this.bpl));)j+=b[w],w+=1;for(k+=w,this.addstavenum?h.add(j+" %"+k):h.add(j),b.splice(0,w),n=o(y,1),s=0;s<n.length;++s)r=(x=n[s])[0],f=x[1],h.add("w: "+f.slice(0,w).join("|")+"|"),f.splice(0,w)}p[l]=this.vceCnt,this.vceCnt+=1}return this.gMaten=[],this.gLyrics=[],this.cnt.prcnt(i+1),p},b.prototype.add=function(t){this.outlist.push(t+"\n")},b.prototype.info=function(t,e){this.infolist.push((void 0===e||e?"-- ":"")+t)},b.prototype.mkHeader=function(t,e,i,r,a){var h,f,p,c,m,g,_,v,x,b,y,k,w,M,O,S,C,I,L,D,A,B,V,F,N,q,z,G,T,P=[],R=[],K=t.slice();for(w=0;w<e.length;++w){L=e[w];try{E(L,["",""],"",t,P,R)}catch(X){s("lousy musicxml: error in part-list",[])}}for(w=0,D=R.join(" "),A={};w<K.length&&w<P.length;++w)B=K[w],V=(q=P[w])[1],F=q[2],0!=B.length&&(N=B[0][0],h=V.replace(/\n/g,"\\n").replace(/\.:/g,".").replace(/^:|:$/g,""),f=F.replace(/\n/g,"\\n").replace(/\.:/g,".").replace(/^:|:$/g,""),A[N]=(h?'nm="'+h+'"':"")+(f?' snm="'+f+'"':""));for(I=this.mnum>-1?"%%measurenb "+this.mnum+"\n":"",p=[n("X:%d\n%s\n%s",[this.X,this.title,I])],""!==this.scale&&p.push("%%scale "+this.scale+"\n"),""!==this.pagewidth&&p.push("%%pagewidth "+this.pagewidth+"cm\n"),""!==this.leftmargin&&p.push("%%leftmargin "+this.leftmargin+"cm\n"),""!==this.rightmargin&&p.push("%%rightmargin "+this.rightmargin+"cm\n"),D&&R.length>1&&p.push("%%score "+D+"\n"),c=this.tempo?n("Q:%d/%d=%s\n",[this.tempo_units[0],this.tempo_units[1],this.tempo]):"",m=[],w=0;w<this.cmpL.length;++w)m[L=this.cmpL[w]]=(m[L]||0)+1;g=(m=o(m))[m.length-1][0],g=this.denL?this.denL:g,p.push(n("L:1/%d\n%sM:%s\n",[g,c,this.mtr])),p.push(n("I:linebreak $\nK:%s\n",[this.key])),this.stemless&&p.push("U:s=!stemless!\n");var H=Object.keys(r).sort();for(w=0;w<H.length;++w)p=p.concat(r[H[w]]);for(_ in this.dojef=0,this.clefs){for(x=(q=i[_-1])[0],b=q[1],y=q[2],k=q[3],z=q.slice(4),v=this.clefs[_],z.length&&0>v.indexOf("perc")&&(v=(v+" map=perc").trim()),p.push(n("V:%d %s %s\n",[_,v,A[_]||""])),(_ in r)&&(p.push(n("%%voicemap tab%d\n",[_])),p.push("K:none\nM:none\n%%clef none\n%%staffscale 1.6\n%%flatbeams true\n%%stemdir down\n")),v.indexOf("perc")>-1&&p.push("K:none\n"),this.volpan>1?(x>0&&x!=_&&p.push("%%MIDI channel "+x+"\n"),b>0&&p.push("%%MIDI program "+(b-1)+"\n"),y>=0&&p.push("%%MIDI control 7 "+y+"\n"),k>=0&&p.push("%%MIDI control 10 "+k+"\n")):this.volpan>0&&(z.length&&x>0&&p.push("%%MIDI channel "+x+"\n"),b>0&&p.push("%%MIDI program "+(b-1)+"\n")),w=0;w<z.length;++w)M=z[w].nt,S=z[w].step,O=z[w].midi,(C=z[w].nhd)||(C="normal"),(j(M)!=O||M!=S)&&(this.volpan>0&&p.push("%%MIDI drummap "+M+" "+O+"\n"),p.push("I:percmap "+M+" "+S+" "+O+" "+C+"\n"),this.dojef=this.tstep);g!=this.cmpL[_-1]&&p.push("L:1/"+this.cmpL[_-1]+"\n")}if(this.outlist=p.concat(this.outlist),(T=Object.keys(a).sort()).length){G=[];var Q=this.shiftStem?l.replace("-2","-5"):l,U=this.shiftStem?u.replace("-2","-5"):u,W=this.shiftStem?d.map(function(t){return t.replace("-3","-6")}):d;T.forEach(function(t){G.push(t.length>1?n(U,[t,t]):n(Q,[t,t]))}),this.outlist=W.concat(G,"</defs>\n%%endsvg\n",this.outlist)}},b.prototype.writeall=function(){var t=h.outlist.join("");return this.dojef&&(t=function t(e){var i,n,s,r,a={diamond:1,triangle:1,square:1,normal:1},o=c,h="default",f={default:[]},p={default:[]};for(n=0,i=e.split("\n");n<i.length;++n){if((s=i[n]).indexOf("I:percmap")>=0){var d=(s=s.split(" ").map(function(t){return t.trim()}))[4];d in a&&(d=d+"+,"+d),s="%%map perc"+h+" "+s[1]+" print="+s[2]+" midi="+s[3]+" heads="+d,f[h].push(s)}s.indexOf("%%MIDI")>=0&&p[h].push(s),s.indexOf("V:")>=0&&(r=s.match(/V:\s*(\S+)/))&&!((h=r[1])in f)&&(f[h]=[],p[h]=[])}var l=Object.keys(f).sort();for(n=0;n<l.length;++n)o=o.concat(f[l[n]]);for(n=0,h="default";n<i.length;++n)!((s=i[n]).indexOf("I:percmap")>=0)&&!(s.indexOf("%%MIDI")>=0)&&(s.indexOf("V:")>=0||s.indexOf("K:")>=0?((r=s.match(/V:\s*(\S+)/))&&(h=r[1]),o.push(s),h in p&&p[h].length&&(o=o.concat(p[h]),delete p[h]),s.indexOf("perc")>=0&&-1==s.indexOf("map=")&&(s+=" map=perc"),s.indexOf("map=perc")>=0&&f[h].length>0&&o.push("%%voicemap perc"+h),s.indexOf("map=off")>=0&&o.push("%%voicemap")):o.push(s));return o.join("\n")}(t)),gGotMicrotonalAccidental&&(t=t.replace("X:1\n","X:1\n% Injected for microtonal accidental annotations\n%%annotationfont Palatino 9\n")),[t,this.infolist.join("\n")]},N.prototype.matchSlur=function(t,e,i,n,r,a){if(-1!=["start","stop"].indexOf(t)){if(e||(e="1"),e in this.slurBuf){var o=this.slurBuf[e],h=o[0],f=o[1],p=o[2],c=o[3];t!=h?(i!=f||"start"!=h||c&&a||(p.before.unshift("("),n.after+=")"),delete this.slurBuf[e]):(s("double slur numbers %s-%s in part %d, measure %d, voice %d note %s, first discarded",[t,e,this.msr.ixp+1,this.msr.ixm+1,i,n.ns]),this.slurBuf[e]=[t,i,n,r])}else this.slurBuf[e]=[t,i,n,r]}},N.prototype.doNotations=function(e,i,s){for(var r=Object.keys(f).sort(),a=0;a<r.length;++a){var o=r[a],h=f[o];i.find(o).length&&e.before.push(h)}var p=i.find("ornaments>tremolo");if(p.length){var c=p.attr("type"),d=t(parseInt(p.text()),"/");"single"==c?e.before.unshift("!"+d+"!"):(e.fact=null,this.tstep?"stop"==c&&e.before.unshift("!trem"+p.text()+"!"):"start"==c&&e.before.unshift("!"+d+"-!"))}var l=i.find("technical>fingering");s||l.each(function(){e.before.push("!"+$(this).text()+"!")});var u=i.find("technical>string");if(u.length&&s){if(this.tstep){var m=i.find("technical>fret");m.length&&(e.tab=[u.eq(0).text(),m.eq(0).text()])}else u.each(function(){var t="!"+$(this).text()+"!";0>e.ntdec.indexOf(t)&&(e.ntdec+=t)})}var g=i.find("ornaments>wavy-line");for(var d of g.toArray())switch($(d).attr("type")){case"start":e.before.unshift("!trill(!");break;case"stop":e.after+="!trill)!"}var _=i.find("glissando");if(0==_.length&&(_=i.find("slide")),_.length){var v="wavy"==_.attr("line-type")?"~":"-";"start"==_.attr("type")?e.before.unshift(n("!%s(!",[v])):"stop"==_.attr("type")&&e.before.unshift(n("!%s)!",[v]))}},N.prototype.tabnote=function(t,e,i,n,r){var a,o,h,f,p,c,d,l,u,m,g;for((l=this.step_map[e]+parseInt(t||"0"))>11&&(i+=1,l-=12),l<0&&(i-=1,l+=12),p=r.tab[0],d=r.tab[1],g=0;g<4&&(u=this.note_alts[g%3][l],m=i,["^B","^^B"].indexOf(u)>-1&&(m-=1),["_C","__C"].indexOf(u)>-1&&(m+=1),(u.indexOf("/")>-1||3==g)&&(m=9),a=V(u,m),f=(o=this.tabmap[[n,a]]||["",""])[0],c=o[1],f);++g){if(p==f)return a;3==g&&(s(h="rejected: voice %d note %s string %s fret %s remains: string %s fret %s",[n,a,p,d,f,c]),r.tab=[f,c])}return this.tabmap[[n,a]]=r.tab,a},N.prototype.ntAbc=function(t,e,i,n,r,a){e+=this.clefOct[this.curStf[n]]||0;var o,h=i.find("accidental").text(),f=!1;"other"==h&&("accidentalLowerOneUndecimalQuartertone"==(o=i.find("accidental").attr("smufl"))?h="quarter-flat":"accidentalRaiseOneUndecimalQuartertone"==o?h="quarter-sharp":(f=!0,gGotMicrotonalAccidental=!0,o=-1!=o.toLowerCase().indexOf("raise")||-1!=o.toLowerCase().indexOf("sharp")?"♯?":-1!=o.toLowerCase().indexOf("lower")||-1!=o.toLowerCase().indexOf("flat")?"♭?":-1!=o.toLowerCase().indexOf("natural")?"♮?":"?"));var p=i.find("pitch>alter").text();if(r.tab)return this.tabnote(p,t,e,n,r);a&&this.tstep&&s("no string notation found for note %s in voice %d",[["__","_","","^","^^"][parseInt(p||"0")+2]+V(t,e),n]);var c=V(t,e);!p&&this.msralts[t]&&(p=0);var d=c+"#"+n;if(!p&&d in this.curalts&&(p=0),""===h&&""===p)return c;if(""!=h)p=f?o:({"quarter-flat":-3,"double-flat":-2,"flat-flat":-2,flat:-1,natural:0,sharp:1,"sharp-sharp":2,"double-sharp":2,"quarter-sharp":3})[h];else{if(p=parseFloat(p),d in this.curalts){if(p==this.curalts[d])return c}else if(p==(this.msralts[t]||0))return c;if(i.find("tie").add(i.find("notations>tied")).get().some(function(t){return"stop"==$(t).attr("type")}))return c;s("accidental %d added in part %d, measure %d, voice %d note %s",[p,this.msr.ixp+1,this.msr.ixm+1,n+1,c])}if(this.curalts[d]=p,f)c='"_'+o+'"'+c;else if(void 0==p){var l=!0;switch(gGotMicrotonalAccidental=!0,h){case"natural-sharp":h="♮♯";break;case"natural-flat":h="♮♭";break;case"three-quarters-flat":h="♭;3/4";break;case"three-quarters-sharp":h="♯;3/4";break;case"sharp-down":h="↓♯";break;case"sharp-up":h="♯↑";break;case"natural-down":h="♮↓";break;case"natural-up":h="↑♮";break;case"flat-down":h="↓♭";break;case"flat-up":h="↑♭";break;case"double-sharp-down":h="↓♯♯";break;case"double-sharp-up":h="♯♯↑";break;case"flat-flat-down":h="↓♭♭";break;case"flat-flat-up":h="♭♭↑";break;case"arrow-down":h="↓";break;case"arrow-up":h="↑";break;case"triple-sharp":h="♯♯♯";break;case"triple-flat":h="♭♭♭";break;case"slash-quarter-sharp":h="♯/4";break;case"slash-quarter-flat":h="♭/4";break;case"slash-sharp":h="/♯";break;case"slash-flat":h="/♭";break;case"double-slash-flat":h="//♭";break;case"double-slash-sharp":h="//♯";break;case"sharp-1":h="♯1";break;case"sharp-2":h="♯2";break;case"sharp-3":h="♯3";break;case"sharp-4":h="♯4";break;case"sharp-5":h="♯5";break;case"flat-1":h="♭1";break;case"flat-2":h="♭2";break;case"flat-3":h="♭3";break;case"flat-4":h="♭4";break;case"flat-5":h="♭5";break;case"sori":h="sori";break;case"koron":h="koron";break;default:l=!1}l||(h=-1!=h.toLowerCase().indexOf("raise")||-1!=h.toLowerCase().indexOf("sharp")?"♯?":-1!=h.toLowerCase().indexOf("lower")||-1!=h.toLowerCase().indexOf("flat")?"♭?":-1!=h.toLowerCase().indexOf("natural")?"♮?":"?"),c='"_'+h+'"'+c}else c=["_/","__","_","=","^","^^","^/"][p+3]+c;return c},N.prototype.doNote=function(e){var i,s=new g(0,null),r=parseInt(e.find("voice").text()||"1");this.isSib&&(r+=100*(e.find("staff").text()||"1"));var a=e.find("chord").length>0,o=e.find("pitch>step").text()||e.find("unpitched>display-step").text(),f=e.find("pitch>octave").text()||e.find("unpitched>display-octave").text(),p=e.find("rest").length>0,c=e.find("time-modification>actual-notes").text();if(c){var d=e.find("time-modification>normal-notes").text();s.fact=[parseInt(c),parseInt(d)]}s.tup=e.find("notations>tuplet").map(function(){return $(this).attr("type")}).get();var l=e.find("duration").text(),u=e.find("grace");s.grace=u.length>0,s.before=[""],s.after="",s.grace&&!this.ingrace&&(this.ingrace=1,s.before=["{"],"yes"==u.attr("slash")&&s.before.push("/"));var m=!s.grace&&this.ingrace;if(m&&(this.ingrace=0,this.msc.lastnote.after+="}"),(!l||s.grace)&&(l=0),!p&&"no"==e.attr("print-object")){if(a)return;p=1}s.dur=parseInt(l),p||o&&f||(this.msc.cnt.inc("nopt",r),f=5,o="E");var _=0==(this.curClef&&this.curClef[this.curStf[r]]||"").indexOf("tab"),v=e.find("notations");v.length&&this.doNotations(s,v,_);var x=e.find("stem");if(!p&&x.length&&"none"==x.text()&&(!_||r in this.hasStems||this.tstep)&&(s.before.push("s"),h.stemless=1),(x=e.find("accidental")).length&&"yes"==x.attr("parentheses")&&(s.ntdec+="!courtesy!"),i=p?"no"==e.attr("print-object")||_?"x":"z":this.ntAbc(o,parseInt(f),e,r,s,_),e.find("unpitched").length){var b=this.curClef[this.curStf[r]],y=function e(i,n,s,r){var a,o=0;if(s.indexOf("stafflines=1")>=0&&(o+=4),!r&&s.indexOf("bass")>=0&&(o+=12),o){var h="CDEFGAB".split("");i=h[(a=h.indexOf(i)+o)%7],n+=Math.floor(a/7)}return n>4&&(i=i.toLowerCase()),n>5&&(i+=t(n-5,"'")),n<4&&(i+=t(4-n,",")),i}(o,parseInt(f),b,this.tstep),k=e.find("instrument"),w=k.length?k.attr("id"):"dummyId",M=this.drumInst[w]||j(i),O=e.find("notehead"),S=O.text().replace(" ","-");"x"==S&&(i="^"+i.replace(/\^/g,"").replace(/_/g,"")),("circle-x"==S||"diamond"==S||"triangle"==S)&&(i="_"+i.replace(/\^/g,"").replace(/_/g,"")),"yes"==O.attr("filled")&&(S+="+"),"no"==O.attr("filled")&&(S+="-"),this.drumNotes[r+";"+i]=[y,M,S]}var C=e.find("tie").add(e.find("notations>tied")).get();C.some(function(t){return"start"==$(t).attr("type")})&&(i+="-"),C=e.find("beam").map(function(){return $(this).text()}).get(),s.beam=C.indexOf("continue")>-1||C.indexOf("end")>-1||s.grace,C=e.find("lyric");for(var I=0,E=0;E<C.length;++E){var L=$(C[E]),A=parseInt((L.attr("number")||"1").replace(/^.*verse/,""));0==A?A=I+1:I=A,s.lyrs[A]=D(L)}var B=e.find("stem").text();if(this.wstems&&("up"==B||"down"==B)&&B!=this.stemDir[r]&&(this.stemDir[r]=B,this.msc.appendElem(r,n("[I:stemdir %s]",[B]))),a)this.msc.addChord(s,i);else{var V=parseInt(e.find("staff").text()||"1");if(this.curStf[r]!=V){var F=V-this.curStf[r];this.curStf[r]=V,this.msc.appendElem(r,"[I:staff "+(F>0?"+":"")+F+"]")}this.msc.appendNote(r,s,i)}for(E=0,C=e.find("notations>slur");E<C.length;++E){var N=$(C[E]);this.matchSlur(N.attr("type"),N.attr("number"),r,this.msc.lastnote,s.grace,m)}},N.prototype.doAttr=function(t){if(d={C1:"alto1",C2:"alto2",C3:"alto",C4:"tenor",F4:"bass",F3:"bass3",G2:"treble",TAB:"tab",percussion:"perc"},(l=t.find("divisions").text())&&(this.msr.divs=parseInt(l)),u=parseInt(t.find("transpose>chromatic").text()||"0"),m=t.find("key>fifths").first().text(),g=0==this.msc.tijd&&0==this.msr.ixm,m){var s,r,a,o,f,p,c;_=(B=(s=parseInt(m),r=t.find("key>mode").first().text()||"major",c={maj:8,ion:8,m:11,min:11,aeo:11,mix:9,dor:10,phr:12,lyd:7,loc:13,non:8},o=(p=["Fb","Cb","Gb","Db","Ab","Eb","Bb","F","C","G","D","A","E","B","F#","C#","G#","D#","A#","E#","B#"])[c[r=r.slice(0,3).toLowerCase()]+s]+(8!=c[r]?r:""),a=["F","C","G","D","A","E","B"],[o,f=s>=0?i(a.slice(0,s),e(s,1)):i(a.slice(s),e(-s,-1))]))[0],this.msralts=B[1],g&&!u&&"none"==h.key?h.key=_:_==h.key&&g||(this.msr.attr+="[K:"+_+"]")}(v=t.find("time>beats").text())&&(b=v+"/"+(x=t.find("time>beat-type").text()),g?h.mtr=b:this.msr.attr+="[M:"+b+"]",this.msr.mtr=[parseInt(v),parseInt(x)]),this.msr.mdur=this.msr.divs*this.msr.mtr[0]*4/this.msr.mtr[1];var d,l,u,m,g,_,v,x,b,y,k,w,j,M,O,S,C,I,E,L,D,A,B,V,F,N=this;for(t.find("measure-style").each(function(){var t,e,i,s,r,a,o;t=parseInt($(this).attr("number")||"1"),e=N.stfMap[t],$(this).find("measure-repeat").each(function(){"start"==(i=$(this).attr("type"))?(N.repeat_str[t]=[N.msr.ixm,$(this).text()],e.forEach(function(e){N.msc.insertElem(e,N.repeat_str[t])})):"stop"==i&&(s=N.repeat_str[t][0],a=N.repeat_str[t][1],r=N.msr.ixm-s,a?(o=a+" ",r/=parseInt(a)):o="",N.repeat_str[t][0]=n("[I:repeat %s%d]",[o,r]),delete N.repeat_str[t])})}),(y=t.find("transpose>octave-change").text()||"")&&(u+=12*parseInt(y)),D=t.find("clef"),L=0;L<D.length;L++){w=parseInt((k=$(D[L])).attr("number")||"1"),M="percussion"!=(j=k.find("sign").text())&&"TAB"!=j&&k.find("line").text()||"",O=d[j+M]||"",O+=({"-2":"-15","-1":"-8",1:"+8",2:"+15"})[S=k.find("clef-octave-change").text()||"0"]||"",this.clefOct[w]=-parseInt(S),u&&(O+=" transpose="+u);var q=t.find("staff-details");if(q.length&&(q.attr("number")||1)==w){(V=q.find("staff-lines").text())&&(O+=" stafflines="+(F="3"==V&&"TAB"==j?"|||":V),this.stafflines=parseInt(V));var z=q.find("staff-tuning"),G=[];z.each(function(){G.push($(this).find("tuning-step").text()+$(this).find("tuning-octave").text())}),G.length&&(O+=n(" strings=%s",[G.join(",")]));var T=q.find("capo").text();T&&(O+=n(" capo=%s",[T]))}if(this.curClef[w]=O,g)this.clefMap[w]=O;else for(A=0,C=this.stfMap[w];A<C.length;++A)I=C[A],w!=this.curStf[I]&&(E=w-this.curStf[I],this.curStf[I]=w,j=E>0?"+":"",this.msc.appendElem(I,"[I:staff "+j+E+"]")),this.msc.appendElem(I,"[K:"+O+"]")}},N.prototype.findVoice=function(t,e){var i,n,s,r,a,o,h;if(i=parseInt((s=e.eq(t)).find("staff").text()||"1"),n=(h=this.stfMap[i]).length?h[0]:1,this.dirtov1)return{sn:i,v:n,v1:n};for(r=t+1;r<e.length;++r){if("note"==(s=e.eq(r))[0].tagName)return a=parseInt(s.find("staff").text()||"1"),o=parseInt(s.find("voice").text()||"1"),this.isSib&&(o+=100*a),{sn:a=this.vce2stf[o],v:o,v1:n};if("backup"==s[0].tagName)break}return{sn:i,v:n,v1:n}},N.prototype.doDirection=function(t,e,i){function r(t,e,i,n,s){e&&(i=e.indexOf("!8v")>=0?t.stfMap[s]:[i]).forEach(function(i){null!=n?t.msc.appendElemT(i,e.replace("(",")").replace("ped","ped-up"),n):t.msc.appendElem(i,e)})}function a(t,e,i,n){var a,o,h,p;if(p={down:"!8va(!",up:"!8vb(!",crescendo:"!<(!",diminuendo:"!>(!",start:"!ped!"},u=f.attr("type")||"",a=e+(f.attr("number")||"1"),u in p)h=p[u],a in t.dirStk?(o=t.dirStk[a],delete t.dirStk[a],"stop"==o.type?r(t,h,i,o.tijd,n):(s("%s direction %s has no stop in part %d, measure %d, voice %d",[e,o.type,t.msr.ixp+1,t.msr.ixm+1,i+1]),t.dirStk[a]={type:u,vs:i})):t.dirStk[a]={type:u,vs:i};else if("stop"==u)a in t.dirStk?(o=t.dirStk[a],delete t.dirStk[a],u=o.type,i=o.vs,"stop"==u?(s("%s direction %s has double stop in part %d, measure %d, voice %d",[e,u,t.msr.ixp+1,t.msr.ixm+1,i+1]),h=""):h=p[o.type].replace("(",")").replace("ped","ped-up")):(t.dirStk[a]={type:"stop",tijd:t.msc.tijd},h="");else throw"wrong direction type";r(t,h,i,null,n)}var o,f,c,d,l,u,m,g,_,v,x,b,y,w,j,M,O,S,C,I,E,L="";o=t.attr("placement"),S=(m=this.findVoice(e,i)).sn,l=m.v,C=m.v1;var D="",A={dacapo:"D.C.",dalsegno:"D.S.",tocoda:"dacoda",fine:"fine",coda:"O",segno:"S"};if((f=t.find("sound")).length){if((x=f.find("midi-instrument")).length){for(w in b=f.find("midi-instrument>midi-program").text(),y=f.find("midi-instrument>midi-channel").text(),this.vceInst)this.vceInst[w]==x.attr("id")&&(l=w);j=b?"program":"channel",(M=(b?b-1:y)+"")&&h.volpan>0&&this.msc.appendElem(l,"[I:MIDI= "+j+" "+M+"]")}for(I in(c=f.attr("tempo"))&&(c=parseFloat(c).toFixed(0),E=[1,4]),A)if(f.attr(I)){D=A[I];break}}for(var B=t.children("direction-type"),V=0;V<B.length;++V){d=$(B[V]);var F={whole:[1,1],half:[1,2],quarter:[1,4],eighth:[1,8]},N=d.find("metronome");N.length&&(E=(f=N.find("beat-unit").text()||"")in F?F[f]:F.quarter,N.find("beat-unit-dot").length&&(E=k(3*E[0],2*E[1])),(I=N.find("per-minute").text().match(/[.\d]+/))&&(c=I[0])),(f=d.find("wedge")).length&&a(this,"wedge",l),0==(O=d.find("words")).length&&(O=d.find("rehearsal"));for(var q=0;q<O.length;++q){if(D){this.msc.appendElem(l,n("!%s!",[D]),1);break}g="below"==o?"_":"^";var z=$(O[q]);0>parseFloat(z.attr("default-y")||"0")&&(g="_"),L+=z.text().replace(/"/g,'\\"').replace(/\n/g,"\\n")}for(_ in L=L.trim(),p)v=p[_],d.find("dynamics>"+_).length&&this.msc.appendElem(l,v,1);d.find("coda").length&&this.msc.appendElem(l,"O",1),d.find("segno").length&&this.msc.appendElem(l,"S",1),(f=d.find("octave-shift")).length&&a(this,"octave-shift",l,S),(f=d.find("pedal")).length&&this.ped&&(this.pedVce||(this.pedVce=l),a(this,"pedal",this.pedVce)),"diatonic fretting"==d.find("other-direction").text()&&(this.diafret=1)}c&&(c=parseFloat(c).toFixed(0),0==this.msc.tijd&&0==this.msr.ixm?(h.tempo=c,h.tempo_units=E):this.msc.appendElem(C,n("[Q:%d/%d=%s]",[E[0],E[1],c]))),L&&this.msc.appendElem(l,'"'+g+L+'"',1)},N.prototype.doHarmony=function(t,e,i){var n,s,r,a,o,h,f,p,c,d,l,u,m,g,_;for(n=this.findVoice(e,i).v,s={major:"",minor:"m",augmented:"+",diminished:"dim",dominant:"7","half-diminished":"m7b5"},r={major:"maj",dominant:"",minor:"m",diminished:"dim",augmented:"+",suspended:"sus"},a={second:"2",fourth:"4",seventh:"7",sixth:"6",ninth:"9","11th":"11","13th":"13"},o={1:"#",0:"","-1":"b"},h=t.find("root>root-step","").text(),f=o[t.find("root>root-alter").text()]||"",p="",((c=t.find("kind").text())in s)?c=s[c]:c.indexOf("-")>-1?(d=(_=c.split("-"))[0],l=_[1],0==(c=(r[d]||"")+(a[l]||"")).indexOf("sus")&&(p=c,c="")):"none"==c&&(c=t.find("kind").attr("text")),u=t.find("degree"),e=0;e<u.length;++e)c+=(o[(g=$(u[e])).find("degree-alter").text()]||"")+g.find("degree-value").text();c=c.replace("79","9").replace("713","13").replace("maj6","6"),m=t.find("bass>bass-step").text()+(o[t.find("bass>bass-alter").text()]||""),this.msc.appendElem(n,'"'+h+f+c+p+(m&&"/"+m)+'"',1)},N.prototype.doBarline=function(t){var e=t.find("repeat"),i=0;if(e.length&&(i=e.attr("direction")),this.unfold)return i?"forward"==i?1:2:0;if("right"==(t.attr("location")||"right")){var n=t.find("bar-style").text();"light-light"==n?this.msr.rline="||":"light-heavy"==n&&(this.msr.rline="|]")}i&&("forward"==i?this.msr.lline=":":this.msr.rline=":|");var s=t.find("ending");if(s.length){if("start"==s.attr("type")){var r=(s.attr("number")||"1").replace(/\./g,"").replace(/ /g,"");/^[\d,]+$/.test(r)||(r='"'+r.trim()+'"'),this.msr.lnum=r}else"|"==this.msr.rline&&(this.msr.rline="||")}return 0},N.prototype.doPrint=function(t){if("yes"==t.attr("new-system")||"yes"==t.attr("new-page"))return this.nolbrk?"":"$"},N.prototype.doPartList=function(t){var e,i,s,r,a,o,h,f,p,c,d,l,u,m,g;for(e=0,a=t.find("part-list>score-part");e<a.length;++e){for(i=0,r=a[e],o={},h=$(r).find("midi-instrument");i<h.length;++i){for(s=0,f=$(h[i]),c=["midi-channel","midi-program","volume","pan"],p=[];s<c.length;++s)d=c[s],p.push(f.find(d).text()||this.midDflt[s]);(l=1*p[3])>=-90&&l<=90&&(l=(l+90)/180*127),o[f.attr("id")]=[parseInt(p[0]),parseInt(p[1]),1.27*parseFloat(p[2]),l],(g=f.find("midi-unpitched").text())&&(this.drumInst[f.attr("id")]=g-1)}this.instMid.push(o)}return function t(e,i,n){var s,r,a,o,h,f,p,c,d,l,u,m,g,_;if(0==e.length)return[[],[]];if("part-group"!=(s=e.shift())[0].tagName)return c=(_=t(e,i,n))[0],m=_[1],[[g=["name_tuple",s.find("part-name").text()||"",s.find("part-abbreviation").text()||""]].concat(c),m];if(r=s.attr("number"),"start"!=(a=s.attr("type")))return l=n.pop(),e.length&&"stop"==e[0].attr("type")&&r!=l&&(_=i[l],i[l]=i[r],i[r]=_),[[u=i[r]],e];for(h in o=[],{"group-symbol":0,"group-barline":0,"group-name":0,"group-abbreviation":0})o.push(s.find(h).text()||"");return i[r]=o,n.push(r),f=(_=t(e,i,n))[0],c=(_=t(p=_[1],i,n))[0],d=_[1],[[f].concat(c),d]}(p=function t(e){function i(t){return $(n('<part-group number="%d" type="%s"></part-group>',[t,"stop"]),d)}var s,r,a,o,h,f,p,c,d=e[0];for(s=[],r=[],p=e.children(),f=0;f<p.length;f++)"part-group"==(a=$(p[f]))[0].tagName?(o=a.attr("number"),h=a.attr("type"),c=r.indexOf(o),"start"==h?c>-1?(s.push(i(o)),s.push(a)):(s.push(a),r.push(o)):c>-1&&(r.splice(c,1),s.push(a))):s.push(a);for(f=r.length-1;f>=0;--f)o=r[f],s.push(i(o));return s}(u=t.find("part-list")),{},[])[0]},N.prototype.mkTitle=function(t){var e,i,n,r,a,o,f,p,c,d,l=[],u=[],m=[];for(r=0,e=t.find("work>work-title").text().trim(),i=t.find("movement-title").text().trim(),n=t.find("identification>creator");r<n.length;++r)o=(a=$(n[r])).text(),f=a.attr("type"),o&&(o=o.split("\n").map(function(t){return t.trim()}),"composer"==f?l.push.apply(l,o):("lyricist"==f||"transcriber"==f)&&u.push.apply(u,o));for(r=0,n=t.find("identification>rights");r<n.length;++r)(o=$(n[r]).text())&&(o=o.split("\n").map(function(t){return t.trim()}),u.push.apply(u,o));for(r=0,n=t.find("credit");r<n.length;++r){for(d=0,p="",c=$(n[r]).find("credit-words");d<c.length;++d)p+=$(c[d]).text();m.push(p.replace(/\s*[\r\n]\s*/g," "))}m=function t(n){var s,r,a=[];function o(t,e){return t&&e.indexOf(t)>-1}function h(t){return o(t,s)}for(r=0;r<m.length;++r)s=m[r],!(n<6&&(o(s,e)||o(s,i))||n<5&&(o(s,l)||o(s,u))||n<4&&(o(e,s)||o(i,s))||n<3&&(l.some(h)||u.some(h)))&&(n<2&&/^[\d\W]*$/.test(s)||a.push(s));return 0==n&&e+i&&(a=""),a}(this.ctf),e&&(e="T:"+e.replace(/\n/g,"\nT:")+"\n"),i&&(e+="T:"+i.replace(/\n/g,"\nT:")+"\n"),m.length&&(e+=m.map(function(t){return"T:"+t}).join("\n")+"\n"),l.length&&(e+=l.map(function(t){return"C:"+t}).join("\n")+"\n"),u.length&&(e+=u.map(function(t){return"Z:"+t}).join("\n")+"\n"),e&&(h.title=e.substr(0,e.length-1)),this.isSib=t.find("identification>encoding>software").text().indexOf("Sibelius")>=0,this.isSib&&s("Sibelius MusicXMl is unreliable",[])},N.prototype.doDefaults=function(t){var e,i,n,s,r,a,o,f,p,c;this.doPageFmt&&(e=t.find("defaults")).length&&(p=(i=e.find("scaling>millimeters").text())/(n=e.find("scaling>tenths").text())/10,s=e.find("page-layout>page-width").text()*p,r=(c=e.find("page-layout>page-margins").first()).find("left-margin").text(),a=c.find("right-margin").text(),f=(o=10*p)/.2117,!h.scale&&f&&(h.scale=f.toFixed(2)),!h.pagewidth&&s&&(h.pagewidth=s.toFixed(2)),h.leftmargin||""==r||(h.leftmargin=(r*p).toFixed(2)),h.rightmargin||""==a||(h.rightmargin=(a*p).toFixed(2)))},N.prototype.locStaffMap=function(t){var e={};this.vceInst={},this.msc.vnums={},this.hasStems={},this.stfMap={},this.clefMap={};for(var i=t.find("measure>note"),n=0;n<i.length;n++){var s=$(i[n]),r=parseInt(s.find("voice").text()||"1");this.isSib&&(r+=100*(s.find("staff").text()||"1")),this.msc.vnums[r]=1;var a=parseInt(s.find("staff").text()||"1");if(this.stfMap[a]=[],r in e){var o=e[r];o[a]=(o[a]||0)+1}else{var h={};h[a]=1,e[r]=h}(h=s.find("instrument")).length&&(this.vceInst[r]=$(h).attr("id")),h=s.find("stem"),0==s.find("rest").length&&(0==h.length||"none"!=h.text())&&(this.hasStems[r]=1)}for(r in e){var f=[],p=e[r];for(a in p)f.push([p[a],a]);f.sort(function(t,e){return t[0]-e[0]});var c=f[f.length-1][1];this.stfMap[c].push(r),this.vce2stf[r]=c,this.curStf[r]=c}},N.prototype.addStaffMap=function(t){var e,i,n,s,r,a,o,f,p,c=[],d=Object.keys(this.stfMap).sort();for(i=0;i<d.length;++i){for(a=d[i],r=this.stfMap[a],o=[],f=[],e=0;e<r.length;++e)(n=r[e])in t&&(o.push(t[n]),f.push(void 0==this.hasStems[n]));if(o.length)for(c.push(o),s=(a in this.clefMap)?this.clefMap[a]:"treble",e=0;e<o.length;++e)n=o[e],p="",0==s.indexOf("tab")&&(f[e]&&0>s.indexOf("nostems")&&(p=" nostems"),this.diafret&&0>s.indexOf("diafret")&&(p+=" diafret")),h.clefs[n]=s+p}this.gStfMap.push(c)},N.prototype.addMidiMap=function(t,e){var i,s=this.instMid[t],r=Object.keys(s);i=r.length?s[r[0]]:this.midDflt;var a,o,h,f,p,c=[],d=this;for(a in e)p=(r=Object.keys(this.drumNotes).sort().filter(function(t){return t.split(";")[0]==a})).map(function(t){return{nt:t.split(";")[1],step:d.drumNotes[t][0],midi:d.drumNotes[t][1],nhd:d.drumNotes[t][2]}}),o=e[a],(h=this.vceInst[a]||"")in s?c.push([o,s[h].concat(p)]):c.push([o,i.concat(p)]);c.sort(function(t,e){return t[0]-e[0]}),c.forEach(function(t){d.midiMap.push(t[1])});var l,u,m,g,_=["E","G","B","d","f","a","c'","e'"],v="0,1-,1,1+,2,3,3,4,4,5,6,6+,7,8-,8,8+,9,10,10,11,11,12,13,13+,14".split(",");for(f=0,r=Object.keys(this.tabmap).sort();f<r.length;++f)a=(c=(l=r[f]).match(/(\d+),(.*)/))[1],g=c[2],u=this.tabmap[l][0],m=this.tabmap[l][1],this.diafret&&(m=v[parseInt(m)]),o=e[a],u=this.stafflines-parseInt(u),(c=this.tabVceMap[o]||[]).push(n("%%map tab%d %s print=%s heads=kop%s\n",[o,g,_[u],m])),this.tabVceMap[o]=c,this.koppen[m]=1},N.prototype.parse=function(t){var e={},i=$(t);this.mkTitle(i),this.doDefaults(i);for(var r=this.doPartList(i),a=i.find("part"),o=0;o<a.length;++o){var f=a.eq(o),p=f.find("measure");this.locStaffMap(f),this.drumNotes={},this.clefOct={},this.curClef={},this.stemDir={},this.tabmap={},this.diafret=0,this.stafflines=5,this.msc.initVoices(1);var c=0,d=0,l=[];for(this.msr=new m(o);this.msr.ixm<p.length;){var u=p.eq(this.msr.ixm),g=0,_="";this.msr.reset(),this.curalts={};for(var v=u.children(),x=0;x<v.length;x++){var b=(i=v.eq(x))[0];switch(b.tagName){case"note":this.doNote(i);break;case"attributes":this.doAttr(i);break;case"direction":this.doDirection(i,x,v);break;case"sound":this.doDirection(u,x,v);break;case"harmony":this.doHarmony(i,x,v);break;case"barline":g=this.doBarline(i);break;case"backup":var y=parseInt(i.find("duration").text());F(y,this.msr)&&this.msc.incTime(-y);break;case"forward":F(y=parseInt(i.find("duration").text()),this.msr)&&this.msc.incTime(y);break;case"print":_=this.doPrint(i)}}this.msc.addBar(_,this.msr),l.push(this.msr.divs),1==g?(d=this.msr.ixm,this.msr.ixm+=1):2==g?c<1?(this.msr.ixm=d,c+=1):(c=0,this.msr.ixm+=1):this.msr.ixm+=1}for(var k in this.repeat_str){var w=this.repeat_str[k];w[0]=n("[I:repeat %s %d]",[w[1],1])}var j=this.msc.outVoices(l,o);for(k in this.addStaffMap(j),this.addMidiMap(o,j),j)e[k]=j[k]}Object.keys(e).length?h.mkHeader(this.gStfMap,r,this.midiMap,this.tabVceMap,this.koppen):s("nothing written, %s has no notes ...",[h.fnmext])},vertaal=function(t,e){gGotMicrotonalAccidental=!1;var i={u:0,b:0,n:0,c:0,v:0,d:0,m:0,x:0,t:0,v1:0,noped:0,stm:0,mnum:-1,p:"f",s:0,addstavenum:1};for(var n in e)i[n]=e[n];i.p=i.p?i.p.split(","):[],h=new b(".abc","",0,i);var r=new N(i);try{r.parse(t)}catch(a){s("** exception occurred: %s",[a])}return h.writeall()}}(),"undefined"!=typeof exports&&(exports.vertaal=vertaal,exports.xml2abc_VERSION=xml2abc_VERSION);