var SDExportWidthAll=480,SDBatchImageExportStatusText="",SDTheBatchImageExportOKButton=null,SDBatchImageExportCancelRequested=!1,SDTheOKButton=null,SDTheNotationImages=[],SDTuneOrder=[],SDTuneArray=[],SmartDrawTuneCurrent=null,SmartDrawTitles=null,SDExportFormat="0",SDIncipits=[];function SDGenerateFullTextIncipits(){var e,t,a,r,n,l,o,i,s,d,c,u,m,p,S=[];for(e=0,SDIncipits=[];e<totalTunes;++e){var h=r=getTuneByIndex(SDTuneOrder[e]);for(t=0,r=StripTabOne(r=StripChordsOne(r=StripTextAnnotationsOne(r=StripAnnotationsOne(r)))),i=/^M:.*[\r\n]*/gm,d=(s=(r=escape(r=r.replace(i,""))).split("%0A")).length,p="";t<d&&-1==(p=unescape(s[t])).indexOf("K:");++t);p=(p=(p=(p=(p=(p=(p=(p=(p=(p=(p=p.replace("K:","")).trim()).replace("Major","maj")).replace("Minor","min")).replace("Dorian","dor")).replace("Mixolydian","mix")).replace("major","maj")).replace("minor","min")).replace("dorian","dor")).replace("mixolydian","mix")).replace(" ","");var g=[];for(a=0;a<d;++a)if(-1!=(n=unescape(s[a])).indexOf("|")){for(t=0,l=(n=cleanIncipitLine(n)).split("|"),o=[],c=l.length;t<c;++t)""!=l[t]&&o.push(l[t]);for(t=0,c=o.length,u="";t<c;++t)o[t]=o[t].trim(),u+=o[t],t!=c-1&&(u+=" | ");0==(n=u).indexOf(" | ")&&(n=n.substring(3,n.length)),g.push(n)}m=getTuneTitle(h),""!=p&&(m+=" ("+p+")"),S.push({title:m,incipits:g})}for(e=0;e<totalTunes;++e){var D="";D="\n "+S[e].title+" \n\n";var f=S[e].incipits;for(t=0;t<f.length;++t)D+=" ",D+=f[t],D+=" \n";SDIncipits.push(D)}}function SDGenerateIncipits(){for(u=0,SDIncipits=[];u<totalTunes;++u){var e,t,a,r,n,l,o,i,s,d,c,u,m,p,S=e=getTuneByIndex(SDTuneOrder[u]);for(m=0,e=StripTabOne(e=StripChordsOne(e=StripTextAnnotationsOne(e=StripAnnotationsOne(e)))),n=/^M:.*[\r\n]*/gm,o=(l=(e=escape(e=e.replace(n,""))).split("%0A")).length,c="";m<o&&-1==(c=unescape(l[m])).indexOf("K:");++m);for(m=0,c=(c=(c=(c=(c=(c=(c=(c=(c=(c=(c=c.replace("K:","")).trim()).replace("Major","maj")).replace("Minor","min")).replace("Dorian","dor")).replace("Mixolydian","mix")).replace("major","maj")).replace("minor","min")).replace("dorian","dor")).replace("mixolydian","mix")).replace(" ","");m<o;++m)if(-1==(t=unescape(l[m])).indexOf("%%score")&&-1!=t.indexOf("|")){if(m<=o-2)for(p=m+1;p<o;++p){var h=unescape(l[p]);if(-1!=h.indexOf("|")){t+=h;break}}break}for(m=0,a=(t=cleanIncipitLine(t)).split("|"),r=[],i=a.length;m<i;++m)""!=a[m]&&r.push(a[m]);for((i=r.length)>3&&(i=3),s="",m=0;m<i;++m)r[m]=r[m].trim(),s+=r[m],m!=i-1&&(s+=" | ");0==(t=s).indexOf(" | ")&&(t=t.substring(3,t.length)),t=(t=t.replaceAll("  "," ")).length>40?(t=t.substring(0,40)).trim():t.trim(),d=getTuneTitle(S),""!=c&&(d+=" ("+c+")"),t=" "+d+" \n\n "+t+" ",SDIncipits.push(t)}}function SDEncodeABCToolsShareURL(e,t,a,r,n){t=(t=(t=(t=t.trim()).replace(/[^a-zA-Z0-9_\-. ]+/ig,"")).replace(/\s/g,"_")).replace(/\..+$/,"");var l="https://michaeleskin.com/abctools/abctools.html?lzw="+LZString.compressToEncodedURIComponent(e)+"&format="+a+"&ssp="+r+"&pdf=one&pn=br&fp=yes&name="+t;return(n&&(l+="&play=1"),l.length>8100)?"https://michaeleskin.com/abctools/abctools.html":l}function SDInjectPlaybackHeaders(e){return e=InjectStringBelowTuneHeader(e,"%abcjs_soundfont fatboy"),e=InjectStringBelowTuneHeader(e,"%%MIDI program 0"),e=InjectStringBelowTuneHeader(e,"%%MIDI bassprog 0"),e=InjectStringBelowTuneHeader(e,"%%MIDI chordprog 0"),e=InjectStringBelowTuneHeader(e,"%%MIDI bassvol 64"),e=(e=InjectStringBelowTuneHeader(e,"%%MIDI chordvol 64")).replace("\n\n","")}function SDGenerateTuneArray(e){for(var t=[],a=e.split(/^X:/gm),r=a.length,n=1;n<r;++n){var l="X:"+a[n];l=SDInjectPlaybackHeaders(l);var o=getTuneTitle(l),i=GetRadioValue("notenodertab"),s=SDEncodeABCToolsShareURL(l,o,i,10,!0);t.push({name:o,abc:l,ShareURL:s})}return t}function SDDoTextIncipitsExport(e){SDGenerateIncipits(),e(!0)}function SDDoFullTextIncipitsExport(e){SDGenerateFullTextIncipits(),e(!0)}function SDDoBatchImageExport(e){function t(t){n--,SDTheOKButton.click(),SDBatchImageExportCancelRequested?e(!1):0!=n?setTimeout(function(){var e=getTuneByIndex(SDTuneOrder[++l]),t=getTuneTitle(e);SDBatchImageExportStatusText.innerText="Generating SmartDraw image for tune "+(l+1)+" of "+r+": "+t,SDExportImageDialog(e,a,l,null,!1)},100):(SDTheBatchImageExportOKButton.click(),SDBatchImageExportCancelRequested=!1,e(!0))}function a(e,a){SDDownloadJPG(t,a)}var r,n=CountTunes();if(0!=n){var l=0;SDBatchImageExportCancelRequested=!1,SDTheBatchImageExportOKButton=null,SDTheBatchImageExportStatusText=null;var o="Generating SmartDraw image for tune "+(l+1)+" of "+(r=n);o=makeCenteredPromptString(o),DayPilot.Modal.alert(o,{theme:"modal_flat",top:290,scrollWithPage:AllowDialogsToScroll(),okText:"Cancel"}).then(function(e){SDBatchImageExportCancelRequested=!0});var i=document.getElementsByClassName("modal_flat_main");i[i.length-1].style.zIndex=100001;for(var s=document.getElementsByClassName("modal_flat_ok"),d=null,c=0;c<s.length;++c)if("Cancel"==(d=s[c]).innerText){SDTheBatchImageExportOKButton=d;break}var u=document.getElementsByClassName("modal_flat_content");(SDBatchImageExportStatusText=u[u.length-1]).style.textAlign="center";var m=getTuneByIndex(SDTuneOrder[l]),p=getTuneTitle(m);return SDBatchImageExportStatusText.innerText="Generating SmartDraw image for tune "+(l+1)+" of "+r+": "+p,SDExportImageDialog(m,a,l,null,!1),!0}}function SDExportImageDialog(e,t,a,r,n){SDTheOKButton=null,gPlayerABC=e;var l=GetRadioValue("notenodertab"),o=GetABCJSParams(l);o.oneSvgPerLine=!1,!function r(){modal_msg='<div id="playerholder" style="height:'+(window.innerHeight-340)+'px;overflow-y:auto;margin-bottom:15px;">',modal_msg+='<div id="abcplayer">',modal_msg+='<div id="playback-paper"></div>',modal_msg+="</div>",modal_msg+="</div>",modal_msg+="</p>";var n,l=window.innerWidth,i=GetRadioValue("notenodertab");isDesktopBrowser()?(n=.45*l)<850&&(n=850):n=800,DayPilot.Modal.alert(modal_msg,{theme:"modal_flat",top:40,width:n,okText:"Close",scrollWithPage:isMobileBrowser()});for(var s=document.getElementsByClassName("modal_flat_ok"),d=null,c=0;c<s.length;++c)if("Close"==(d=s[c]).innerText){SDTheOKButton=d;break}postProcessTab([ABCJS.renderAbc("playback-paper",e,o)[0]],"playback-paper",i,!0),t&&setTimeout(function(){t(a,SDTheOKButton)},10)}()}function SDDownloadJPG(e,t){PreProcessSVGImageForDownload();var a=document.querySelector("#playback-paper svg");if(!a){if(!e)return;e(t)}var r=document.createElement("canvas"),n=a.getBoundingClientRect();a=a.cloneNode(!0);var l=n.width,o=n.height,i=SDExportWidthAll,s=SDExportWidthAll*o/l;r.width=i,r.height=s,r.style.width=i,r.style.height=s,a.setAttribute("width",i+"px"),a.setAttribute("height",s+"px");var d=r.getContext("2d");d.fillStyle="#ffffff",d.fillRect(0,0,r.width,r.height),document.createElement("img");var c=new XMLSerializer().serializeToString(a);SDTheNotationImages.push({data:"data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(c))),width:i,height:s}),e(t)}function AddSmartDrawSetName(){DayPilot.Modal.prompt("Please enter a new tune set name:","Set #",{theme:"modal_flat",top:200,autoFocus:!0,scrollWithPage:AllowDialogsToScroll()}).then(function(e){var t,a,r=e.result;if(null!=r){if(SmartDrawTuneCurrent)a=SmartDrawTuneCurrent,t=SmartDrawTuneCurrent.cloneNode(!0),SmartDrawTuneCurrent&&SmartDrawTuneCurrent.classList.remove("draggable_tune_selected");else{let n=document.querySelectorAll("#sortable-tune-list .draggable_tune");t=(a=n[0]).cloneNode(!0)}t.innerHTML=r,t.setAttribute("data_tune_index","-1"),document.getElementById("sortable-tune-list").insertBefore(t,a),(SmartDrawTuneCurrent=t).classList.add("draggable_tune_selected")}})}function DeleteSmartDrawSetName(){SmartDrawTuneCurrent&&"-1"==SmartDrawTuneCurrent.getAttribute("data_tune_index")&&(document.getElementById("sortable-tune-list").removeChild(SmartDrawTuneCurrent),SmartDrawTuneCurrent=null)}function saveVSON(e,t){if(0==t.length){DayPilot.Modal.alert("Nothing to save!",{theme:"modal_flat",top:200});return}if(0==(e=e.replace(/[^a-zA-Z0-9_\-. ]+/ig,"")).length)return null;e=e.replace(/\..+$/,""),e+=".vson";var a=document.createElement("a");document.body.appendChild(a),a.style="display: none";var r=new Blob([t],{type:"text/plain"}),n=window.URL.createObjectURL(r);a.href=n,a.download=e,a.click(),document.body.removeChild(a),setTimeout(function(){window.URL.revokeObjectURL(n)},1e3)}function ExportSmartDrawSetList(){DayPilot.Modal.prompt("Please enter a file name for your exported SmartDraw file:","SmartDraw_Set_List",{theme:"modal_flat",top:200,autoFocus:!0,scrollWithPage:AllowDialogsToScroll()}).then(function(e){var t=e.result;null!=t&&DayPilot.Modal.prompt("Please name for your SmartDraw set list:","My Set List",{theme:"modal_flat",top:200,autoFocus:!0,scrollWithPage:AllowDialogsToScroll()}).then(function(e){var a=document.getElementById("smartdraw_export_width").value;SDExportWidthAll=isNaN(a=parseInt(a))?480:a,SDExportFormat=document.getElementById("smartdraw_format_select").value;var r=e.result;if(null!=r){SDTheNotationImages=[];let n=document.querySelectorAll("#sortable-tune-list .draggable_tune");var l=Array.from(n).map(e=>e.getAttribute("data_tune_index")),o=l.length;SDTuneOrder=[];for(var i=0;i<o;++i){var a=l[i];"-1"!=a&&SDTuneOrder.push(parseInt(a))}switch(SDTuneArray=SDGenerateTuneArray(gTheABC.value),SDExportFormat){case"0":SDDoBatchImageExport(s);break;case"1":SDDoFullTextIncipitsExport(s);break;case"2":SDDoTextIncipitsExport(s)}function s(e){if(e){var a=n.length,l=new VS.Document;l.AddTitle(r).SetTextSize(18);var o=l.GetTheShape();o.SetFillColor("#FFFFFF"),o.SetTextColor("#000000"),o.SetLabel(r),o.SetTextBold(!0);var s=o.AddShapeConnector("Orgchart");s.SetDirection(VS.Directions.Right);var d=s,c=0,u=!1;for(i=0;i<a;++i){var m=n[i],p=m.innerHTML,S=!1;if("-1"==m.getAttribute("data_tune_index")&&(S=!0),S){var h=s.AddShape();h.SetFillColor("#FFFFFF"),h.SetTextColor("#000000"),h.SetLabel(p),h.SetTextBold(!0),u=!0}else{u&&((d=h.AddShapeConnector("Orgchart")).SetDirection(VS.Directions.Right),u=!1);var h=d.AddShape();h.SetFillColor("#FFFFFF"),h.SetTextColor("#000000");var g=SDTuneOrder[c];switch(SDExportFormat){case"0":h.SetImage(SDTheNotationImages[c].data),h.SetMinWidth(SDTheNotationImages[c].width),h.SetMinHeight(SDTheNotationImages[c].height),h.SetHyperlink(SDTuneArray[g].ShareURL);break;case"1":case"2":h.SetLabel(SDIncipits[c]),h.SetTextFont("Courier"),h.SetTextBold(!0),h.SetTextAlignH("Left"),h.SetTextGrow(VS.TextGrow.Horizontal),h.SetHyperlink(SDTuneArray[g].ShareURL)}c++}}saveVSON(t,l.toJSON())}}}})})}function SmartDrawExport(){var e,t=[];SDBatchImageExportStatusText="",SDTheBatchImageExportOKButton=null,SDBatchImageExportCancelRequested=!1,SDTheOKButton=null,SDTheNotationImages=[],SDTuneOrder=[],SDTuneArray=[],SmartDrawTuneCurrent=null,SmartDrawTitles=null,totalTunes=CountTunes();var a=(SmartDrawTitles=GetTunebookIndexTitles()).length;if(0==a){var r="No tunes to create SmartDraw set list.";r=makeCenteredPromptString(r),DayPilot.Modal.alert(r,{theme:"modal_flat",top:200,scrollWithPage:AllowDialogsToScroll()});return}var n='<div id="sortable-tune-list" style="overflow:auto;height:475px;margin-top:18px">';for(e=0;e<a;++e)n+='<div class="draggable_tune" draggable="true" data_tune_index="'+e+'">'+SmartDrawTitles[e]+"</div>";n+="</div>",modal_msg='<p style="text-align:center;font-size:18pt;font-family:helvetica;margin-left:15px;">SmartDraw Set List Builder&nbsp;&nbsp;<span style="font-size:24pt;" title="View documentation in new tab"><a href="https://michaeleskin.com/abctools/userguide.html#smartdraw_export" target="_blank" style="text-decoration:none;position:absolute;left:20px;top:20px">?</a></span></p>',modal_msg+='<p style="margin-top:18px;font-size:12pt;">Drag and drop the tune names to change the order of the tunes in the set list.</p>',modal_msg+='<p style="margin-top:18px;font-size:12pt;">Add or delete set name markers using the buttons below.</p>',modal_msg+=n,modal_msg+='<p style="text-align:center;margin-top:24px;"><input id="smartdraw_add_set_name" class="advancedcontrols btn btn-injectcontrols-headers" onclick="AddSmartDrawSetName();" type="button" value="Add Set Name" title="Adds a set name element to the list"><input id="smartdraw_delete_set_name" class="advancedcontrols btn btn-injectcontrols-headers" onclick="DeleteSmartDrawSetName();" type="button" value="Delete Set Name" title="Deletes a selected set name element from the list"><input id="smartdraw_export" class="advancedcontrols btn btn-smartdraw-export" onclick="ExportSmartDrawSetList();" type="button" value="Export SmartDraw Set List" title="Exports the set list as a SmartDraw diagram"></p>',modal_msg+='<p class="smartdraw_export_all_text">',modal_msg+='Tune export format: <select id="smartdraw_format_select" title="Select the SmartDraw export format">',modal_msg+='<option value="0">Notation</option>',modal_msg+='<option value="1">ABC Full Text</option>',modal_msg+='<option value="2">ABC Incipits</option>',modal_msg+="</select>",modal_msg+='&nbsp;&nbsp;&nbsp;Notation width to export: <input id="smartdraw_export_width" type="number" min="0" step="1" max="4096" title="Notation width to export in 1/100 of an inch increments" autocomplete="off"/>',modal_msg+="</p>",DayPilot.Modal.alert(modal_msg,{theme:"modal_flat",top:50,width:650,scrollWithPage:AllowDialogsToScroll(),autoFocus:!1}),document.getElementById("smartdraw_export_width").value=SDExportWidthAll,document.getElementById("smartdraw_format_select").value=SDExportFormat;let l=document.getElementById("sortable-tune-list"),o=null;l.addEventListener("click",function(e){var t=e.target;t.classList&&t.classList.contains("draggable_tune")&&(o=t,SmartDrawTuneCurrent&&SmartDrawTuneCurrent.classList.remove("draggable_tune_selected"),SmartDrawTuneCurrent=o,o.classList.add("draggable_tune_selected"))}),l.addEventListener("dragstart",function(e){o=e.target,e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",o.innerHTML),SmartDrawTuneCurrent&&SmartDrawTuneCurrent.classList.remove("draggable_tune_selected"),SmartDrawTuneCurrent=o,o.classList.add("draggable_tune_selected")}),l.addEventListener("dragover",function(e){e.preventDefault();let a=e.target;if(a&&a!==o&&a.classList.contains("draggable_tune")){let r=a.getBoundingClientRect(),n=(e.clientY-r.top)/(r.bottom-r.top)>.5;l.insertBefore(o,n?a.nextElementSibling:a);let i=document.querySelectorAll("#sortable-tune-list .draggable_tune");t=Array.from(i).map(e=>e.getAttribute("data_tune_index"))}}),l.addEventListener("dragend",function(){o=null})}