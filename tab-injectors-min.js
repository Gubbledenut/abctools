var angloFingeringsGenerator=function(e,a){var n,t=function(e,a,n,t){this.name=e,this.notes=a,this.cost=n,this.finger=t},r={L1a:new t("L1a",["E,","F,"],10,"l4"),L2a:new t("L2a",["A,","_B,"],10,"l4"),L3a:new t("L3a",["^C","_E"],10,"l3"),L4a:new t("L4a",["A","G"],10,"l2"),L5a:new t("L5a",["^G","_B"],10,"l1"),L1:new t("L1",["C,","G,"],1,"l4"),L2:new t("L2",["G,","B,"],1,"l4"),L3:new t("L3",["C","D"],1,"l3"),L4:new t("L4",["E","F"],1,"l2"),L5:new t("L5",["G","A"],1,"l1"),L6:new t("L6",["B,","A,"],1,"l4"),L7:new t("L7",["D","^F"],2,"l4"),L8:new t("L8",["G","A"],2,"l3"),L9:new t("L9",["B","c"],2,"l2"),L10:new t("L10",["d","e"],2,"l1"),R1:new t("R1",["c","B"],1,"r1"),R2:new t("R2",["e","d"],1,"r2"),R3:new t("R3",["g","f"],2,"r3"),R4:new t("R4",["c'","a"],2,"r4"),R5:new t("R5",["e'","b"],2,"r4"),R6:new t("R6",["g","^f"],1,"r1"),R7:new t("R7",["b","a"],1,"r2"),R8:new t("R8",["d'","c'"],1,"r3"),R9:new t("R9",["g'","e'"],1,"r4"),R10:new t("R10",["b'","^f'"],1,"r4")};new t("L1a",["E,","F,"],10,"l4"),new t("L2a",["A,","_B,"],10,"l4"),new t("L3a",["^C","_E"],10,"l3"),new t("L4a",["A","G"],10,"l2"),new t("L5a",["^G","_B"],10,"l1"),new t("L1",["C,","G,"],1,"l4"),new t("L2",["G,","B,"],1,"l4"),new t("L3",["C","D"],1,"l3"),new t("L4",["E","F"],1,"l2"),new t("L5",["G","A"],1,"l1"),new t("L6",["B,","A,"],1,"l4"),new t("L7",["D","^F"],2,"l4"),new t("L8",["G","A"],2,"l3"),new t("L9",["B","c"],2,"l2"),new t("L10",["d","e"],1,"l1"),new t("R1",["c","B"],1,"r1"),new t("R2",["e","d"],2,"r2"),new t("R3",["g","f"],2,"r3"),new t("R4",["c'","a"],2,"r4"),new t("R5",["e'","b"],2,"r4"),new t("R6",["g","^f"],1,"r1"),new t("R7",["b","a"],1,"r2"),new t("R8",["d'","c'"],1,"r3"),new t("R9",["g'","e'"],1,"r4"),new t("R10",["b'","^f'"],1,"r4");var s={L1a:new t("L1a",["E,","F,"],10,"l4"),L2a:new t("L2a",["A,","_B,"],10,"l4"),L3a:new t("L3a",["^C","_E"],10,"l3"),L4a:new t("L4a",["A","G"],10,"l2"),L5a:new t("L5a",["^G","_B"],10,"l1"),L1:new t("L1",["C,","G,"],1,"l4"),L2:new t("L2",["G,","B,"],1,"l4"),L3:new t("L3",["C","D"],1,"l3"),L4:new t("L4",["E","F"],1,"l2"),L5:new t("L5",["G","A"],1,"l1"),L6:new t("L6",["B,","A,"],1,"l4"),L7:new t("L7",["D","^F"],2,"l4"),L8:new t("L8",["G","A"],2,"l3"),L9:new t("L9",["B","z"],2,"l2"),L9a:new t("L9",["z","c"],1,"l2"),L10:new t("L10",["d","e"],1,"l1"),R1:new t("R1",["c","x"],2,"r1"),R1x:new t("R1",["x","B"],1,"r1"),R2:new t("R2",["e","d"],2,"r2"),R3:new t("R3",["g","f"],2,"r3"),R4:new t("R4",["c'","a"],2,"r4"),R5:new t("R5",["e'","b"],2,"r4"),R6:new t("R6",["g","^f"],1,"r1"),R7:new t("R7",["b","a"],1,"r2"),R8:new t("R8",["d'","c'"],1,"r3"),R9:new t("R9",["g'","e'"],1,"r4"),R10:new t("R10",["b'","^f'"],1,"r4")};new t("R1a",["^d","^c"],1,"r1"),new t("R2a",["^c","^d"],10,"r2"),new t("R3a",["^g","g"],10,"r3"),new t("R4a",["^c'","_b"],10,"r4"),new t("R5a",["a","d'"],10,"r4");var i={R1a:new t("R1a",["^d","^c"],10,"r1"),R2a:new t("R2a",["^c","^d"],1,"r2"),R3a:new t("R3a",["^g","g"],10,"r3"),R4a:new t("R4a",["^c'","_b"],10,"r4"),R5a:new t("R5a",["a","d'"],10,"r4")},c={R1a:new t("R1a",["^c","^d"],10,"r1"),R2a:new t("R2a",["a","g"],10,"r2"),R3a:new t("R3a",["^g","_b"],10,"r3"),R4a:new t("R4a",["^c'","_e'"],10,"r4"),R5a:new t("R5a",["a","f'"],10,"r4")},l=null,o=null,u=null,_=null,f=null,d=0;function h(e){}function g(e){if(h("Got input:"+e),!function e(){var a,n=parseInt(gInjectTab_ConcertinaFingering);switch(l=[],o=[],n){case 0:for(var t in i)l[t]=i[t];for(var t in c)o[t]=c[t];for(var t in r)l[t]=r[t],o[t]=r[t];break;case 1:for(var t in i)l[t]=i[t];for(var t in c)o[t]=c[t];for(var t in s)l[t]=s[t];for(var t in s)o[t]=s[t]}u=((a=u=0==parseInt(gInjectTab_ConcertinaStyle)?l:o).L1a.name=gAngloButtonNames[0],a.L2a.name=gAngloButtonNames[1],a.L3a.name=gAngloButtonNames[2],a.L4a.name=gAngloButtonNames[3],a.L5a.name=gAngloButtonNames[4],a.R1a.name=gAngloButtonNames[5],a.R2a.name=gAngloButtonNames[6],a.R3a.name=gAngloButtonNames[7],a.R4a.name=gAngloButtonNames[8],a.R5a.name=gAngloButtonNames[9],a.L1.name=gAngloButtonNames[10],a.L2.name=gAngloButtonNames[11],a.L3.name=gAngloButtonNames[12],a.L4.name=gAngloButtonNames[13],a.L5.name=gAngloButtonNames[14],a.R1.name=gAngloButtonNames[15],a.R1x&&(a.R1x.name=gAngloButtonNames[15]),a.R2.name=gAngloButtonNames[16],a.R3.name=gAngloButtonNames[17],a.R4.name=gAngloButtonNames[18],a.R5.name=gAngloButtonNames[19],a.L6.name=gAngloButtonNames[20],a.L7.name=gAngloButtonNames[21],a.L8.name=gAngloButtonNames[22],a.L9.name=gAngloButtonNames[23],a.L9a&&(a.L9a.name=gAngloButtonNames[23]),a.L10.name=gAngloButtonNames[24],a.R6.name=gAngloButtonNames[25],a.R7.name=gAngloButtonNames[26],a.R8.name=gAngloButtonNames[27],a.R9.name=gAngloButtonNames[28],a.R10.name=gAngloButtonNames[29],a)}(),null==(_=function e(a){var n,t,r=null,s=a.match(/[kK]: *([A-G])([b#])? *(.*?)$/m);if(null==s||s.length<3)return null;if(h("Got base key of '"+(n=void 0==s[2]?s[1]:s[1]+s[2])+"' and extra of '"+(t=s[3].toLowerCase())+"'"),""==t||-1!=t.search("maj")||-1!=t.search("ion")?(h("Mode: Ionian (major)"),r=v(n,0)):-1!=t.search("mix")?(h("Mode: Mixolydian"),r=v(n,1)):-1!=t.search("dor")?(h("Mode: Dorian"),r=v(n,2)):-1!=t.search("m")&&-1==t.search("mix")||-1!=t.search("min")||-1!=t.search("aeo")?(h("Mode: Aeolian (minor)"),r=v(n,3)):-1!=t.search("phr")?(h("Mode: Phrygian"),r=v(n,4)):-1!=t.search("loc")?(h("Mode: Locrian"),r=v(n,5)):-1!=t.search("lyd")?(h("Mode: Lydian"),r=v(n,-1)):-1!=t.search("exp")?(h("(Accidentals to be explicitly specified)"),r=v("C",0)):(h("Failed to determine key signature mode"),r=null),null==r)return r;var i=t.match(/_./g),c=t.match(/\^./g);for(note in i)r.flats+=i[note][1].toUpperCase();for(note in c)r.sharps+=c[note][1].toUpperCase();return r}(e)))return"ERROR: Unknown or unsupported key signature";var a,d=function e(a){for(var n,t,r=a,s=/^\w:.*$/mg;n=s.exec(a);)r=R(r,n.index,n[0].length);for(var i=/"[^"]*"/gm;t=i.exec(r);)for(var c=t.index,l=c+t[0].length,o=c;o<l;++o)r=r.substring(0,o)+"*"+r.substring(o+1);for(i=/\[[^\]|]*\]/g;t=i.exec(r);)for(var c=t.index,l=c+t[0].length,o=c;o<l;++o)r=r.substring(0,o)+"*"+r.substring(o+1);for(i=/^%%begintext((.|\n)*)%%endtext/gm;t=i.exec(r);)for(var c=t.index,l=c+t[0].length,o=c;o<l;++o)r=r.substring(0,o)+"*"+r.substring(o+1);for(i=/^%.*$/gm;t=i.exec(r);)for(var c=t.index,l=c+t[0].length,o=c;o<l;++o)r=r.substring(0,o)+"*"+r.substring(o+1);h("sanitized input:"+r);for(var u=/([=^_]?[a-gA-G][',]?|\|)/g,f=[];t=u.exec(r);){var d=t[1];if("|"==d)_.accidentalFlats="",_.accidentalSharps="",_.accidentalNaturals="";else{var g=A(d);h("UnNormalized="+d+" normalized="+g),f.push(new p(t.index,d,g))}}return f}(e),g=function e(a){var n={};for(var t in a){var r=a[t].notes;if(null==r){h("Failed to find entry for button "+b);continue}r.forEach(function(e){null==n[e]?n[e]=[a[t]]:n[e].push(a[t]),null==n[e=L(e)]?n[e]=[a[t]]:n[e].push(a[t])})}return n}(u);!function e(a){for(var n in a)a[n].sort(function(e,a){return e.cost-a.cost})}(g);var G,F=(a=function e(a,n){for(var r=null,s=null,i=0;i<a.length;++i){var c=a[i],l=c.normalizedValue,o=n[l];if(null==o||o.length<1){h("Failed to find button for note "+l),h("Attempting respell...");var u=L(l);if(h("Respelled as "+u),null==(o=n[u])||o.length<1)return h("Respelling as "+u+" failed to find a button."),abcOutput="ERROR:Failed to find button for note '"+l+"'",null}var _=[];o.forEach(function(e){_.push(new m(c,e,w(c,e)))}),null==r&&(r=_),null!=s&&s.forEach(function(e){e.nextStates=_}),s=_}var f=new m(null,new t("root",[],0,"none"));return f.nextStates=r,f}(d,g),n=1e8,f={},function e(a){if(0==a.nextStates.length)return h("Last state, note="+a.note.normalizedValue+" button="+a.button.name+". Popping up the stack"),new $([a],a.button.cost);var n=a.note,t=null,r=null;if(null!=n&&(t=n.unNormalizedValue,r=n.normalizedValue),h("Choosing: current note="+r+" button="+a.button.name),f[a])return h("Already visited state note="+a.note.normalizedValue+" button="+a.button.name),f[a];for(var s=new $([],1e7),i=0;i<a.nextStates.length;++i){var c=a.nextStates[i];h("Trying next ["+i+"/"+a.nextStates.length+"] note="+c.note.normalizedValue+" button="+c.button.name);var l=e(c);if(null==l)return h("Could not get fingerings"),null;var o=a.button.cost;if(0!=l.states.length){var u=l.states[0].button;l.states[0].button.finger,x(a.button,u)&&(h("Penalizing finger hop for note "+r),o+=100)}if(h("path had cost of "+l.cost+" my cost="+o),l.cost+o<s.cost){var _=l.states.slice(0);_.unshift(a),h("New best path for note["+r+"], cost="+(s=new $(_,l.cost+o)).cost)}}return f[a]=s,h("Done choosing: current note="+r+" button="+a.button.name+" best cost="+s.cost),s}(a));return null==F?(h("No fingerings generated!"),abcOutput):abcOutput=function e(a,n,t){if(n.states.shift(),n.states.length!=t.length)return"ERROR: Internal error. Length mismatch";for(var r=a,s=0,i=parseInt(gInjectTab_TabLocation),c=0;c<n.states.length;++c){var l=t[c].index+s,o=n.states[c].button.name;if(gInjectTab_UseBarForDraw)switch(i){case 0:if(n.states[c].direction==C)o='"^'+o+'"';else{for(var u=o.length,_="",f=0;f<u;++f)_+="_";var d=o;o=(o='"^'+_+";")+d+'"'}break;case 1:if(n.states[c].direction==C)o='"_ ;'+o+'"';else{for(var u=o.length,_="",f=0;f<u;++f)_+="_";var d=o;o=(o='"_'+_+";")+d+'"'}}else switch(i){case 0:o=(o='"^'+o+";")+n.states[c].direction+'"';break;case 1:o=(o='"_'+o+";")+n.states[c].direction+'"'}var h=o.length;r=r.substr(0,l)+o+r.substr(l),s+=h}return r}(e,F,d)}var $=function(e,a){this.states=e,this.cost=a},p=function(e,a,n){this.index=e,this.unNormalizedValue=a,this.normalizedValue=n},m=function(e,a,n){this.note=e,this.button=a,this.direction=n,this.nextStates=[],this.id=d++,this.toString=function(){var e="["+this.id+"] Note:";return this.note?e+=this.note.normalizedValue:e+="none",e+=" Button:"+this.button.name}};function v(e,a){var n="FCGDAEB",t={sharps:"",flats:""},r=n.indexOf(e[0])-1;if(-2==r)return h("Bad tonic: "+e),null;"b"==e.slice(1)?r-=7:"#"==e.slice(1)&&(r+=7);var s=r-a;return s>7?(h("Too many sharps: "+s),null):s<-7?(h("Too many flats: "+-1*s),null):(s>0?t.sharps=n.slice(0,s):s<0&&(t.flats=n.slice(s)),t.accidentalSharps="",t.accidentalFlats="",t.accidentalNaturals="",t)}function w(e,a){if(e.normalizedValue==a.notes[0])return C;if(e.normalizedValue==a.notes[1])return y;var n=function e(a){var n=a,t={"^A":"_B","^D":"_E","^G":"_A"};for(var r in t)n=(n=n.replace(r,t[r])).replace(r.toLowerCase(),t[r].toLowerCase());return n}(e.normalizedValue);return n==a.notes[0]?C:n==a.notes[1]?y:" "}function x(e,a){return e.finger==a.finger&&e.name!=a.name}function R(e,a,n){for(var t="",r=0;r<n;++r)t+="*";return e.substr(0,a)+t+e.substr(a+n)}function L(e){var a=e,n={_B:"^A","^B":"C",_C:"B",_D:"^C","^D":"_E",_E:"^D","^E":"F",_F:"E",_G:"^F","^G":"_A"};for(var t in n)a=(a=a.replace(t,n[t])).replace(t.toLowerCase(),n[t].toLowerCase());return a}function A(e){var a=e.search(/[A-G]/i);if(-1==a)return h("Failed to find basename for value!"),e;var n=e.substr(a,1).toUpperCase();return"="==e.substr(0,1)?(_.accidentalFlats=_.accidentalFlats.replace(n,""),_.accidentalSharps=_.accidentalSharps.replace(n,""),_.accidentalNaturals+=n,e.substr(1)):"_"==e.substr(0,1)?(_.accidentalFlats+=n,_.accidentalSharps=_.accidentalSharps.replace(n,""),_.accidentalNaturals=_.accidentalNaturals.replace(n,""),e):"^"==e.substr(0,1)?(_.accidentalFlats=_.accidentalFlats.replace(n,""),_.accidentalNaturals=_.accidentalNaturals.replace(n,""),_.accidentalSharps+=n,e):-1!=_.accidentalNaturals.search(n)?e:-1!=_.sharps.search(n)||-1!=_.accidentalSharps.search(n)?"^"+e:-1!=_.flats.search(n)||-1!=_.accidentalFlats.search(n)?"_"+e:e}function G(e){return e.split(/^X:.*$/gm).length-1}function F(e,a){return"X:"+e.split(/^X:/gm)[a+1]}function B(e){return e=e.replace(/"[^"]*"/gm,"")}var C="↓",y="↑";return function e(a,n){var t=a.split(/^X:.*$/gm).length-1,r=gInjectTab_FontFamily,s=gInjectTab_TabFontSize,i=gInjectTab_MusicSpace,c=gInjectTab_StaffSep,l=parseInt(gInjectTab_TabLocation),o=gInjectTab_StripChords;C=gInjectTab_PushGlyph,y=gInjectTab_DrawGlyph;for(var u=FindPreTuneHeader(a),_=!1,f=[],d=0;d<t;++d){var h=F(a,d),$=h;if(isSectionHeader(h)){u+=h;continue}(0==l||1==l&&o)&&(h=B(h));try{h=g(h)}catch(p){u+=$;var m=getTuneTitle($);f.push(m),_=!0;continue}h=InjectStringBelowTuneHeader(h,"%%staffsep "+c),h=InjectStringAboveTuneHeader(h,"%%annotationfont "+r+" "+s),h=InjectStringAboveTuneHeader(h,"%%musicspace "+i),u+=h}if(_){for(var v='<p style="text-align:center;font-size:18px;margin-bottom:18px">No Anglo Concertina tablature generated for one or more tunes:</p>',w=0;w<f.length;++w)v+='<p style="text-align:center;font-size:18px;">'+f[w]+"</p>";n(u,!0,v+='<p style="text-align:center;font-size:18px;line-height:24px;margin-top:18px">Some notes may be outside the range or not available on the selected style of Anglo concertina.</p>')}else n(u,!1,"")}(e,a)},boxTabGenerator=function(e){var a=null;function n(e){}function t(e){n("Got input:"+e);var t=parseInt(gInjectTab_BoxStyle);if(null==(a=function e(a){var t,r,i=null,c=a.match(/[kK]: *([A-G])([b#])? *(.*?)$/m);if(null==c||c.length<3)return null;if(n("Got base key of '"+(t=void 0==c[2]?c[1]:c[1]+c[2])+"' and extra of '"+(r=c[3].toLowerCase())+"'"),""==r||-1!=r.search("maj")||-1!=r.search("ion")?(n("Mode: Ionian (major)"),i=s(t,0)):-1!=r.search("mix")?(n("Mode: Mixolydian"),i=s(t,1)):-1!=r.search("dor")?(n("Mode: Dorian"),i=s(t,2)):-1!=r.search("m")&&-1==r.search("mix")||-1!=r.search("min")||-1!=r.search("aeo")?(n("Mode: Aeolian (minor)"),i=s(t,3)):-1!=r.search("phr")?(n("Mode: Phrygian"),i=s(t,4)):-1!=r.search("loc")?(n("Mode: Locrian"),i=s(t,5)):-1!=r.search("lyd")?(n("Mode: Lydian"),i=s(t,-1)):-1!=r.search("exp")?(n("(Accidentals to be explicitly specified)"),i=s("C",0)):(n("Failed to determine key signature mode"),i=null),null==i)return i;var l=r.match(/_./g),o=r.match(/\^./g);for(note in l)i.flats+=l[note][1].toUpperCase();for(note in o)i.sharps+=o[note][1].toUpperCase();return i}(e)))return"ERROR: Unknown or unsupported key signature";var o=function e(t,s){for(var o,u,_=t,f=/^\w:.*$/mg;o=f.exec(t);)_=i(_,o.index,o[0].length);for(var d=/"[^"]*"/gm;u=d.exec(_);)for(var h=u.index,g=h+u[0].length,$=h;$<g;++$)_=_.substring(0,$)+"*"+_.substring($+1);for(d=/\[[^\]|]*\]/g;u=d.exec(_);)for(var h=u.index,g=h+u[0].length,$=h;$<g;++$)_=_.substring(0,$)+"*"+_.substring($+1);for(d=/^%%begintext((.|\n)*)%%endtext/gm;u=d.exec(_);)for(var h=u.index,g=h+u[0].length,$=h;$<g;++$)_=_.substring(0,$)+"*"+_.substring($+1);for(d=/^%.*$/gm;u=d.exec(_);)for(var h=u.index,g=h+u[0].length,$=h;$<g;++$)_=_.substring(0,$)+"*"+_.substring($+1);n("sanitized input:"+_);for(var p=/([=^_]?[a-gA-G][',]?|\|)/g,m=[];u=p.exec(_);){var v=u[1];if("|"==v)a.accidentalFlats="",a.accidentalSharps="",a.accidentalNaturals="";else{var w=l(v);n("UnNormalized="+v+" normalized="+w);var x=c(w,s);m.push(new r(u.index,v,w,x))}}return m}(e,t);return function e(a,n){for(var t,r=a,s=0,i=parseInt(gInjectTab_TabLocation),c=0;c<n.length;++c){var l=n[c].index+s,o=n[c].glyph,u=o.length,_=o.substr(0,1),d=o.substr(1,u-1);if(0==o.indexOf("10")&&(_=o.substr(0,2),d=o.substr(2,u-1)),gInjectTab_UseBarForDraw)switch(i){case 0:if(d==f)t='"^'+_+'"';else{for(var h=_.length,g="",$=0;$<h;++$)g+="_";if(gIsChrome||gIsSafari)switch(_){case"①":case"②":case"③":case"④":case"⑤":case"⑥":case"⑦":case"⑧":case"⑨":case"⑩":case"⑪":g+="_"}t=(t='"^'+g+";")+_+'"'}break;case 1:if(d==f)t='"_ ;'+_+'"';else{for(var h=_.length,g="",$=0;$<h;++$)g+="_";if(gIsChrome||gIsSafari)switch(_){case"①":case"②":case"③":case"④":case"⑤":case"⑥":case"⑦":case"⑧":case"⑨":case"⑩":case"⑪":g+="_"}t=(t='"_'+g+";")+_+'"'}}else switch(i){case 0:t=(t='"^'+_+";")+d+'"';break;case 1:t=(t='"_'+_+";")+d+'"'}var p=t.length;r=r.substr(0,l)+t+r.substr(l),s+=p}return r}(e,o)}var r=function(e,a,n,t){this.index=e,this.unNormalizedValue=a,this.normalizedValue=n,this.glyph=t};function s(e,a){var t="FCGDAEB",r={sharps:"",flats:""},s=t.indexOf(e[0])-1;if(-2==s)return n("Bad tonic: "+e),null;"b"==e.slice(1)?s-=7:"#"==e.slice(1)&&(s+=7);var i=s-a;return i>7?(n("Too many sharps: "+i),null):i<-7?(n("Too many flats: "+-1*i),null):(i>0?r.sharps=t.slice(0,i):i<0&&(r.flats=t.slice(i)),r.accidentalSharps="",r.accidentalFlats="",r.accidentalNaturals="",r)}function i(e,a,n){for(var t="",r=0;r<n;++r)t+="*";return e.substr(0,a)+t+e.substr(a+n)}function c(e,a){switch(a){case 0:var n={"^D,":"①"+f,"_E,":"①"+f,"E,":"1"+f,"F,":"x ","^F,":"②"+f,"_G,":"②"+f,"G,":"2"+f,"^G,":"①"+d,"_A,":"①"+d,"A,":"1"+d,"^A,":"②"+d,"_B,":"②"+d,"B,":"2"+d,C:"3"+f,"^C":"③"+d,_D:"③"+d,D:"3"+d,"^D":"④"+f,_E:"④"+f,E:"4"+f,F:"4"+d,"^F":"⑤"+f,_G:"⑤"+f,G:"5"+f,"^G":"⑤"+d,_A:"⑤"+d,A:"5"+d,"^A":"⑥"+d,_B:"⑥"+d,B:"6"+d,c:"6"+f,"^c":"⑦"+d,_d:"⑦"+d,d:"7"+d,"^d":"⑦"+f,_e:"⑦"+f,e:"7"+f,f:"8"+d,"^f":"⑧"+f,_g:"⑧"+f,g:"8"+f,"^g":"⑨"+d,_a:"⑨"+d,a:"9"+d,"^a":"⑩"+d,_b:"⑩"+d,b:"10"+d,"c'":"9"+f,"^c'":"⑪"+d,"_d'":"⑪"+d,"d'":"x ","^d'":"⑩"+f,"_e'":"⑩"+f,"e'":"10"+f,"^f'":"⑪"+f,"_g'":"⑪"+f},t=n[e];if(!t)return"x ";break;case 1:var n={"F,":"①"+f,"^F,":"1"+f,"_G,":"1"+f,"G,":"x ","^G,":"②"+f,"_A,":"②"+f,"A,":"2"+f,"^A,":"①"+d,"_B,":"①"+d,"B,":"1"+d,C:"②"+d,"^C":"2"+d,_D:"2"+d,D:"3"+f,"^D":"③"+d,_E:"③"+d,E:"3"+d,F:"④"+f,"^F":"4"+f,_G:"4"+f,G:"4"+d,"^G":"⑤"+f,_A:"⑤"+f,A:"5"+f,"^A":"⑤"+d,_B:"⑤"+d,B:"5"+d,c:"⑥"+d,"^c":"6"+d,_d:"6"+d,d:"6"+f,"^d":"⑦"+d,_e:"⑦"+d,e:"7"+d,f:"⑦"+f,"^f":"7"+f,_g:"7"+f,g:"8"+d,"^g":"⑧"+f,_a:"⑧"+f,a:"8"+f,"^a":"⑨"+d,_b:"⑨"+d,b:"9"+d,"c'":"⑩"+d,"^c'":"10"+d,"_d'":"10"+d,"d'":"9"+f,"^d'":"⑪"+d,"_e'":"⑪"+d,"e'":"x ","f'":"⑩"+f,"^f'":"10"+f,"_g'":"10"+f,"g'":"x ","^g'":"⑪"+f,"_a'":"⑪"+f},t=n[e];if(!t)return"x "}return t}function l(e){var t=e.search(/[A-G]/i);if(-1==t)return n("Failed to find basename for value!"),e;var r=e.substr(t,1).toUpperCase();return"="==e.substr(0,1)?(a.accidentalFlats=a.accidentalFlats.replace(r,""),a.accidentalSharps=a.accidentalSharps.replace(r,""),a.accidentalNaturals+=r,e.substr(1)):"_"==e.substr(0,1)?(a.accidentalFlats+=r,a.accidentalSharps=a.accidentalSharps.replace(r,""),a.accidentalNaturals=a.accidentalNaturals.replace(r,""),e):"^"==e.substr(0,1)?(a.accidentalFlats=a.accidentalFlats.replace(r,""),a.accidentalNaturals=a.accidentalNaturals.replace(r,""),a.accidentalSharps+=r,e):-1!=a.accidentalNaturals.search(r)?e:-1!=a.sharps.search(r)||-1!=a.accidentalSharps.search(r)?"^"+e:-1!=a.flats.search(r)||-1!=a.accidentalFlats.search(r)?"_"+e:e}function o(e){return e.split(/^X:.*$/gm).length-1}function u(e,a){return"X:"+e.split(/^X:/gm)[a+1]}function _(e){return e=e.replace(/"[^"]*"/gm,"")}var f="↓",d="↑";return function e(a){var n=a.split(/^X:.*$/gm).length-1,r=gInjectTab_FontFamily,s=gInjectTab_TabFontSize,i=gInjectTab_MusicSpace,c=gInjectTab_StaffSep,l=parseInt(gInjectTab_TabLocation),o=gInjectTab_StripChords;f=gInjectTab_PushGlyph,d=gInjectTab_DrawGlyph;for(var h=FindPreTuneHeader(a),g=0;g<n;++g){var $=u(a,g);if(isSectionHeader($)){h+=$;continue}(0==l||1==l&&o)&&($=_($)),$=t($),$=InjectStringBelowTuneHeader($,"%%staffsep "+c),$=InjectStringAboveTuneHeader($,"%%annotationfont "+r+" "+s),$=InjectStringAboveTuneHeader($,"%%musicspace "+i),h+=$}return h}(e)},bambooFluteTabGenerator=function(e){var a="",n=null;function t(e){}function r(e){t("Got input:"+e);var r=parseInt(gBambooFluteKey);if(null==(n=function e(a){var n,r,s=null,c=a.match(/[kK]: *([A-G])([b#])? *(.*?)$/m);if(null==c||c.length<3)return null;if(t("Got base key of '"+(n=void 0==c[2]?c[1]:c[1]+c[2])+"' and extra of '"+(r=c[3].toLowerCase())+"'"),""==r||-1!=r.search("maj")||-1!=r.search("ion")?(t("Mode: Ionian (major)"),s=i(n,0)):-1!=r.search("mix")?(t("Mode: Mixolydian"),s=i(n,1)):-1!=r.search("dor")?(t("Mode: Dorian"),s=i(n,2)):-1!=r.search("m")&&-1==r.search("mix")||-1!=r.search("min")||-1!=r.search("aeo")?(t("Mode: Aeolian (minor)"),s=i(n,3)):-1!=r.search("phr")?(t("Mode: Phrygian"),s=i(n,4)):-1!=r.search("loc")?(t("Mode: Locrian"),s=i(n,5)):-1!=r.search("lyd")?(t("Mode: Lydian"),s=i(n,-1)):-1!=r.search("exp")?(t("(Accidentals to be explicitly specified)"),s=i("C",0)):(t("Failed to determine key signature mode"),s=null),null==s)return s;var l=r.match(/_./g),o=r.match(/\^./g);for(note in l)s.flats+=l[note][1].toUpperCase();for(note in o)s.sharps+=o[note][1].toUpperCase();return s}(e)))return"ERROR: Unknown or unsupported key signature";var u=function e(a,r){for(var i,u,_=a,f=/^\w:.*$/mg;i=f.exec(a);)_=c(_,i.index,i[0].length);for(var d=/"[^"]*"/gm;u=d.exec(_);)for(var h=u.index,g=h+u[0].length,$=h;$<g;++$)_=_.substring(0,$)+"*"+_.substring($+1);for(d=/\[[^\]|]*\]/g;u=d.exec(_);)for(var h=u.index,g=h+u[0].length,$=h;$<g;++$)_=_.substring(0,$)+"*"+_.substring($+1);for(d=/^%%begintext((.|\n)*)%%endtext/gm;u=d.exec(_);)for(var h=u.index,g=h+u[0].length,$=h;$<g;++$)_=_.substring(0,$)+"*"+_.substring($+1);for(d=/^%.*$/gm;u=d.exec(_);)for(var h=u.index,g=h+u[0].length,$=h;$<g;++$)_=_.substring(0,$)+"*"+_.substring($+1);t("sanitized input:"+_);for(var p=/([=^_]?[a-gA-G][',]?|\|)/g,m=[];u=p.exec(_);){var v=u[1];if("|"==v)n.accidentalFlats="",n.accidentalSharps="",n.accidentalNaturals="";else{var w=o(v);t("UnNormalized="+v+" normalized="+w);var x=l(w,r);m.push(new s(u.index,v,w,x))}}return m}(e,r);return a=function e(a,n){for(var t,r=a,s=0,i=0;i<n.length;++i){var c=n[i].index+s,l=n[i].glyph,o=l.length,u=l.substr(0,o-1),_=l.substr(o-1,o-1),f=(t="-"!=_?'"_'+_+";"+u+'"':'"_ ;'+u+';•"').length;r=r.substr(0,c)+t+r.substr(c),s+=f}return r}(e,u)}var s=function(e,a,n,t){this.index=e,this.unNormalizedValue=a,this.normalizedValue=n,this.glyph=t};function i(e,a){var n="FCGDAEB",r={sharps:"",flats:""},s=n.indexOf(e[0])-1;if(-2==s)return t("Bad tonic: "+e),null;"b"==e.slice(1)?s-=7:"#"==e.slice(1)&&(s+=7);var i=s-a;return i>7?(t("Too many sharps: "+i),null):i<-7?(t("Too many flats: "+-1*i),null):(i>0?r.sharps=n.slice(0,i):i<0&&(r.flats=n.slice(i)),r.accidentalSharps="",r.accidentalFlats="",r.accidentalNaturals="",r)}function c(e,a,n){for(var t="",r=0;r<n;++r)t+="*";return e.substr(0,a)+t+e.substr(a+n)}function l(e,a){var n="";switch(a){case 0:var t={"G,":"5-","^G,":"#5-","_A,":"#5-","A,":"6-","^A,":"#6-","_B,":"#6-","B,":"7-",C:"1 ","^C":"#1 ",_D:"#1 ",D:"2 ","^D":"#2 ",_E:"#2 ",E:"3 ",F:"4 ","^F":"#4 ",_G:"#4 ",G:"5 ","^G":"#5 ",_A:"#5 ",A:"6 ","^A":"#6 ",_B:"#6 ",B:"7 ",c:"1•","^c":"#1•",_d:"#1•",d:"2•","^d":"#2•",_e:"#2•",e:"3•",f:"4•","^f":"#4•",_g:"#4•",g:"5•","^g":"#5•",_a:"#5•",a:"6•","^a":"#6•",_b:"#6•",b:"7•"};if(!(n=t[e]))return"x ";break;case 1:var t={"G,":"4-","^G,":"#4-","_A,":"#4-","A,":"5-","^A,":"#5-","_B,":"#5-","B,":"6-",C:"#6-","^C":"7-",_D:"7-",D:"1 ","^D":"#1 ",_E:"#1 ",E:"2 ",F:"#2 ","^F":"3 ",_G:"3 ",G:"4 ","^G":"#4 ",_A:"#4 ",A:"5 ","^A":"#5 ",_B:"#5 ",B:"6 ",c:"#6 ","^c":"7 ",_d:"7 ",d:"1•","^d":"#1•",_e:"#1•",e:"2•",f:"#2•","^f":"3•",_g:"3•",g:"4•","^g":"#4•",_a:"#4•",a:"5•","^a":"#5•",_b:"#5•",b:"6•","c'":"#6•","^c'":"7•"};if(!(n=t[e]))return"x ";break;case 2:var t={"G,":"1-","^G,":"#1-","_A,":"#1-","A,":"2-","^A,":"#2-","_B,":"#2-","B,":"3-",C:"4-","^C":"#4-",_D:"#4-",D:"5-","^D":"#5-",_E:"#5-",E:"6-",F:"#6-","^F":"7-",G:"1 ","^G":"#1 ",_A:"#1 ",A:"2 ","^A":"#2 ",_B:"#2 ",B:"3 ",c:"4 ","^c":"#4 ",_d:"#4 ",d:"5 ","^d":"#5 ",_e:"#5 ",e:"6 ",f:"#6 ","^f":"7 ",_g:"7 ",g:"1•","^g":"#1•",_a:"#1•",a:"2•","^a":"#2•",_b:"#2•",b:"3•","c'":"4•","^c'":"#4•","_d'":"#4•","d'":"5•","^d'":"#5•","_e'":"#5•","e'":"6•","f'":"6#•","^f'":"7•","_g'":"7•"};if(!(n=t[e]))return"x ";break;case 3:var t={"A,":"1-","^A,":"#1-","_B,":"#1-","B,":"2-",C:"#2-","^C":"3-",_D:"3-",D:"4-","^D":"#4-",_E:"#4-",E:"5-",F:"#5-","^F":"6-",_G:"6-",G:"6#-","^G":"7-",_A:"7-",A:"1 ","^A":"#1 ",_B:"#1 ",B:"2 ",c:"#2 ","^c":"3 ",_d:"3 ",d:"4 ","^d":"#4 ",_e:"#4 ",e:"5 ",f:"#5 ","^f":"6 ",_g:"6 ",g:"6# ","^g":"7 ",_a:"7 ",a:"1•","^a":"#1•",_b:"#1•",b:"2•","c'":"#2•","^c'":"3•","_d'":"3•","d'":"4•","^d'":"#4•","_e'":"#4•","e'":"5•","f'":"#5•","^f'":"6•","_g'":"6•","g'":"6#•","^g'":"7•","_a'":"7•"};if(!(n=t[e]))return"x "}return n}function o(e){var a=e.search(/[A-G]/i);if(-1==a)return t("Failed to find basename for value!"),e;var r=e.substr(a,1).toUpperCase();return"="==e.substr(0,1)?(n.accidentalFlats=n.accidentalFlats.replace(r,""),n.accidentalSharps=n.accidentalSharps.replace(r,""),n.accidentalNaturals+=r,e.substr(1)):"_"==e.substr(0,1)?(n.accidentalFlats+=r,n.accidentalSharps=n.accidentalSharps.replace(r,""),n.accidentalNaturals=n.accidentalNaturals.replace(r,""),e):"^"==e.substr(0,1)?(n.accidentalFlats=n.accidentalFlats.replace(r,""),n.accidentalNaturals=n.accidentalNaturals.replace(r,""),n.accidentalSharps+=r,e):-1!=n.accidentalNaturals.search(r)?e:-1!=n.sharps.search(r)||-1!=n.accidentalSharps.search(r)?"^"+e:-1!=n.flats.search(r)||-1!=n.accidentalFlats.search(r)?"_"+e:e}function u(e){return e.split(/^X:.*$/gm).length-1}function _(e,a){return"X:"+e.split(/^X:/gm)[a+1]}function f(e){return e=e.replace(/"[^"]*"/gm,"")}return function e(a){var n=a.split(/^X:.*$/gm).length-1,t=gInjectTab_FontFamily,s=gInjectTab_TabFontSize,i=gInjectTab_MusicSpace,c=gInjectTab_StaffSep;parseInt(gInjectTab_TabLocation);for(var l=gInjectTab_StripChords,o=FindPreTuneHeader(a),u=0;u<n;++u){var d=_(a,u);if(isSectionHeader(d)){o+=d;continue}switch(l&&(d=f(d)),d=r(d),d=InjectStringBelowTuneHeader(d,"%%staffsep "+c),parseInt(gBambooFluteKey)){case 0:d=InjectStringBelowTuneHeader(d,"%%text "),d=InjectStringBelowTuneHeader(d,"%%text 1=C");break;case 1:d=InjectStringBelowTuneHeader(d,"%%text "),d=InjectStringBelowTuneHeader(d,"%%text 1=D");break;case 2:d=InjectStringBelowTuneHeader(d,"%%text "),d=InjectStringBelowTuneHeader(d,"%%text 1=G");break;case 3:d=InjectStringBelowTuneHeader(d,"%%text "),d=InjectStringBelowTuneHeader(d,"%%text 1=A")}d=InjectStringAboveTuneHeader(d,"%%annotationfont "+t+" "+s),d=InjectStringAboveTuneHeader(d,"%%musicspace "+i),o+=d}return o}(e)};
